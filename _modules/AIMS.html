

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIMS &mdash; AIMS 2.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=b21de401"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            AIMS
              <img src="../_static/AIMS_logo_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../project.html">Project Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../download.html">Download <code class="docutils literal notranslate"><span class="pre">AIMS</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../formats.html">File formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes.html">List of changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AIMS.html">The <code class="docutils literal notranslate"><span class="pre">AIMS</span></code> program</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model.html">The <code class="docutils literal notranslate"><span class="pre">model</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../constants.html">The <code class="docutils literal notranslate"><span class="pre">constants</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions.html">The <code class="docutils literal notranslate"><span class="pre">functions</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities.html">The <code class="docutils literal notranslate"><span class="pre">utilities</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plot_interpolation_test.html">The <code class="docutils literal notranslate"><span class="pre">plot_interpolation_test</span></code> tool</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AIMS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">AIMS</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for AIMS</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding: utf-8</span>
<span class="c1"># $Id: AIMS.py</span>
<span class="c1"># Author: Daniel R. Reese &lt;daniel.reese@obspm.fr&gt;</span>
<span class="c1"># Copyright (C) Daniel R. Reese and contributors</span>
<span class="c1"># Copyright license: GNU GPL v3.0</span>
<span class="c1">#</span>
<span class="c1">#   AIMS is free software: you can redistribute it and/or modify</span>
<span class="c1">#   it under the terms of the GNU General Public License as published by</span>
<span class="c1">#   the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#   (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#   This program is distributed in the hope that it will be useful,</span>
<span class="c1">#   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#   GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#   You should have received a copy of the GNU General Public License</span>
<span class="c1">#   along with AIMS.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module which contains the main program for AIMS as well as various classes</span>
<span class="sd">which intervene when calculating the priors and likelihood function:</span>

<span class="sd">- :py:class:`Distribution`: a class which represents a probability distribution</span>
<span class="sd">- :py:class:`Prior_list`: a class with a list of priors</span>
<span class="sd">- :py:class:`Mode`: a class used to represent observed modes</span>
<span class="sd">- :py:class:`Combination`: a class used to represent a linear frequency combination</span>
<span class="sd">- :py:class:`Combination_function`: a class used to represent functions of frequency combinations</span>
<span class="sd">- :py:class:`Likelihood`: a class used to represent the likelihood function</span>
<span class="sd">- :py:class:`Probability`: a class which groups the priors and likelihood function together</span>

<span class="sd">This module relies on the `emcee &lt;http://dan.iel.fm/emcee/current/&gt;`_ package to apply</span>
<span class="sd">an MCMC algorithm which will return a representative sample of models for a given set</span>
<span class="sd">of seismic an classic constraints.</span>

<span class="sd">.. warning::</span>
<span class="sd">  In various places in this module, for instance in the :py:class:`Prior_list`</span>
<span class="sd">  and :py:class:`Likelihood` classes, various methods return what is described</span>
<span class="sd">  as a :math:`\\chi^2` value.  Technically, these are not :math:`\\chi^2` values,</span>
<span class="sd">  but rather :math:`-\\chi^2/2`, i.e. the argument of the exponential function</span>
<span class="sd">  which intervenes in the Gaussian probability distribution.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;restructuredtext&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;2.2.0&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="c1"># AIMS configuration option</span>
<span class="k">if</span> <span class="s1">&#39;AIMS_configure.py&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">AIMS_configure</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">config</span>  <span class="c1"># user-defined configuration parameters</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;AIMS_configure.py path: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="vm">__file__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># import modules from the AIMS package</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">model</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">utilities</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aims_fortran</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functions</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dill</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlines</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">truncnorm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">emcee</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">corner</span>

<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">ptemcee</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lxml</span><span class="w"> </span><span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">set_start_method</span>

<span class="c1"># provide a way to deactivate tqdm, if AIMS is running in batch mode</span>
<span class="c1"># or if tqdm is not available:</span>
<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tqdm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># recreate np.int and np.float aliases if need be</span>
<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">)):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">float</span> <span class="o">=</span> <span class="nb">float</span>
<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">)):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">int</span> <span class="o">=</span> <span class="nb">int</span>

<span class="c1"># If config file does not have write_samples, default to True</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;write_samples&#39;</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">write_samples</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># parameters associated with the grid</span>
<span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; grid of models &quot;&quot;&quot;</span>

<span class="n">grid_params_MCMC</span> <span class="o">=</span> <span class="p">()</span>
<span class="sd">&quot;&quot;&quot; parameters used in the MCMC run (excluding surface correction parameters) &quot;&quot;&quot;</span>

<span class="n">grid_params_MCMC_with_surf</span> <span class="o">=</span> <span class="p">()</span>
<span class="sd">&quot;&quot;&quot; parameters used in the MCMC run (including surface correction parameters) &quot;&quot;&quot;</span>

<span class="n">ndims</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot; number of dimensions for MCMC parameters (includes :py:data:`nsurf`)  &quot;&quot;&quot;</span>

<span class="n">nsurf</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot; number of surface term parameters &quot;&quot;&quot;</span>

<span class="c1"># parameters associated with probabilities</span>
<span class="n">prob</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:py:class:`Probability` type object that represents the probability function</span>
<span class="sd">which includes the likelihood and priors</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">tight_ball_distributions</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; :py:class:`Prior_list` type object with the distributions for the initial tight ball &quot;&quot;&quot;</span>

<span class="n">log0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e300</span>
<span class="sd">&quot;&quot;&quot; a large negative value used to represent ln(0) &quot;&quot;&quot;</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e290</span>
<span class="sd">&quot;&quot;&quot; threshold for &quot;accepted&quot; models.  Needs to be greater than :py:const:`log0` &quot;&quot;&quot;</span>

<span class="c1"># variables associated with the best model from a scan of the entire grid:</span>
<span class="n">best_grid_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; best model from a scan of the entire grid &quot;&quot;&quot;</span>

<span class="n">best_grid_params</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; parameters for the model :py:data:`best_grid_model`&quot;&quot;&quot;</span>

<span class="n">best_grid_result</span> <span class="o">=</span> <span class="n">log0</span>
<span class="sd">&quot;&quot;&quot; ln(probability) result for the model :py:data:`best_grid_model`&quot;&quot;&quot;</span>

<span class="n">best_age_range</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="sd">&quot;&quot;&quot; Age range on track with :py:data:`best_model_model`&quot;&quot;&quot;</span>

<span class="c1"># variables associated with the best model from the MCMC run:</span>
<span class="n">best_MCMC_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; best model from the MCMC run &quot;&quot;&quot;</span>

<span class="n">best_MCMC_params</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; parameters for the model :py:data:`best_MCMC_model`&quot;&quot;&quot;</span>

<span class="n">best_MCMC_result</span> <span class="o">=</span> <span class="n">log0</span>
<span class="sd">&quot;&quot;&quot; ln(probability) result for the model :py:data:`best_MCMC_model`&quot;&quot;&quot;</span>

<span class="c1"># variables associated with the statistical parameters</span>
<span class="n">statistical_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; model corresponding to statistical parameters &quot;&quot;&quot;</span>

<span class="n">statistical_params</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; parameters for the model :py:data:`statistical_model`&quot;&quot;&quot;</span>

<span class="n">statistical_result</span> <span class="o">=</span> <span class="n">log0</span>
<span class="sd">&quot;&quot;&quot; ln(probability) result for the model :py:data:`statistical_model`&quot;&quot;&quot;</span>

<span class="c1"># other parameters</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; folder in which to write the results &quot;&quot;&quot;</span>

<span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; pool from which to carry out parallel computations &quot;&quot;&quot;</span>

<span class="n">my_map</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; pointer to the map function (either the parallel or sequential versions) &quot;&quot;&quot;</span>

<span class="n">accepted_parameters</span> <span class="o">=</span> <span class="p">[]</span>
<span class="sd">&quot;&quot;&quot; list of parameters associated with accepted models &quot;&quot;&quot;</span>

<span class="n">rejected_parameters</span> <span class="o">=</span> <span class="p">[]</span>
<span class="sd">&quot;&quot;&quot; list of parameters associated with rejected models &quot;&quot;&quot;</span>

<span class="n">nreject_classic</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot; Number of models rejected because of classic constraints &quot;&quot;&quot;</span>

<span class="n">nreject_seismic</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot; Number of models rejected because of seismic constraints &quot;&quot;&quot;</span>

<span class="n">nreject_prior</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot; Number of models rejected based on priors &quot;&quot;&quot;</span>

<span class="n">autocorr_time</span> <span class="o">=</span> <span class="p">[]</span>
<span class="sd">&quot;&quot;&quot; integrated autocorrelelation time (this is useful for testing convergence) &quot;&quot;&quot;</span>

<span class="n">mc2</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot; True if emcee&#39;s version is 2 or prior &quot;&quot;&quot;</span>


<div class="viewcode-block" id="Distribution">
<a class="viewcode-back" href="../AIMS.html#AIMS.Distribution">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Distribution</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which represents a probability distribution, and can yield</span>
<span class="sd">    its value for a given input parameter, or provide a random realisation.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">      Derived from a class originally written by G. Davies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_type</span><span class="p">,</span> <span class="n">_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param _type: type of probability function (current options include</span>
<span class="sd">                       &quot;Gaussian&quot;, &quot;Truncated_gaussian&quot;, &quot;Uniform&quot;, &quot;IMF1&quot;,</span>
<span class="sd">                       &quot;IMF2&quot;, &quot;Uninformative&quot;, &quot;Above&quot;, &quot;Below&quot;)</span>
<span class="sd">        :param _values: list of parameters relevant to the probability function</span>

<span class="sd">        :type _type: string</span>
<span class="sd">        :type _values: list of floats</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">_type</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Type of probability function (&quot;Uniform&quot;, &quot;Gaussian&quot;, &quot;Truncated_gaussian&quot;,</span>
<span class="sd">        &quot;IMF1&quot;, &quot;IMF2&quot;, &quot;Uninformative&quot;, &quot;Above&quot;, or &quot;Below&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">_values</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of parameters relevant to probability function&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return ln of probability distribution function for a particular value.</span>
<span class="sd">        </span>
<span class="sd">        :param value: value at which to evaluate ln of probability distribution function.</span>
<span class="sd">        :type value: float</span>

<span class="sd">        :return: ln(distribution(value))</span>
<span class="sd">        :rtype: float</span>

<span class="sd">        .. note::</span>
<span class="sd">          The results are given to within an additive constant.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Truncated_gaussian&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">log0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">log0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF1&quot;</span><span class="p">:</span>
            <span class="c1"># values[0] &lt; values[1] = mass limits</span>
            <span class="c1"># values[2] = exponent</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">log0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF2&quot;</span><span class="p">:</span>
            <span class="c1"># values[0] &lt; values[1] &lt; values[2] = mass limits</span>
            <span class="c1"># values[3], values[4] = exponents</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">log0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uninformative&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Above&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">log0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Below&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">log0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised distribution: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

<div class="viewcode-block" id="Distribution.realisation">
<a class="viewcode-back" href="../AIMS.html#AIMS.Distribution.realisation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">realisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return random values which statistically follow the probability distribution.</span>

<span class="sd">        :param size: shape of random variates</span>
<span class="sd">        :type size: int or tuple of ints</span>

<span class="sd">        :return: a set of random realisations</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Truncated_gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">truncnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                 <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF1&quot;</span><span class="p">:</span>
            <span class="n">cnst2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cnst1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">cnst2</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">cnst1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">cnst2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF2&quot;</span><span class="p">:</span>
            <span class="n">rlim</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> \
                          <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> \
                          <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> \
                          <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span>
            <span class="n">cnst2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">cnst1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">cnst2</span><span class="p">)</span> <span class="o">/</span> <span class="n">rlim</span>
            <span class="n">cnst4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">cnst3</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">cnst4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rlim</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">Finv</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rlim</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">cnst1</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="n">cnst2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">cnst3</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">rlim</span><span class="p">)</span> <span class="o">+</span> <span class="n">cnst4</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>

            <span class="n">vFinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Finv</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">vFinv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uninformative&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to produce a realisation for an uninformative distribution&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Above&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to produce a realisation for an </span><span class="se">\&quot;</span><span class="s2">Above</span><span class="se">\&quot;</span><span class="s2"> distribution&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Below&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to produce a realisation for a </span><span class="se">\&quot;</span><span class="s2">Below</span><span class="se">\&quot;</span><span class="s2"> distribution&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised distribution: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>


<div class="viewcode-block" id="Distribution.re_centre">
<a class="viewcode-back" href="../AIMS.html#AIMS.Distribution.re_centre">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">re_centre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-centre the probability distribution around the input value.</span>

<span class="sd">        :param value: new value around which to centre the distribution</span>
<span class="sd">        :type value: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Truncated_gaussian&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">dist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">dist</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF1&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;re_centre method not implemented for IMF1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF2&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;re_centre method not implemented for IMF2&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uninformative&quot;</span><span class="p">:</span>
            <span class="c1"># do nothing</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Above&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Below&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised distribution: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>


<div class="viewcode-block" id="Distribution.re_normalise">
<a class="viewcode-back" href="../AIMS.html#AIMS.Distribution.re_normalise">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">re_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-normalise the probability distribution so that its characteristic</span>
<span class="sd">        width corresponds to the input value.</span>

<span class="sd">        :param value: new value around for the chacteristic width</span>
<span class="sd">        :type value: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Truncated_gaussian&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="n">centre</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">-</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF1&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;re_normalise method not implemented for IMF1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF2&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;re_normalise method not implemented for IMF2&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uninformative&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to renormalise an uninformative distribution&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Above&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to renormalise an </span><span class="se">\&quot;</span><span class="s2">Above</span><span class="se">\&quot;</span><span class="s2"> distribution&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Below&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to renormalise a </span><span class="se">\&quot;</span><span class="s2">Below</span><span class="se">\&quot;</span><span class="s2"> distribution&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised distribution: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the mean value of the probability distribution.</span>

<span class="sd">        :return:  the mean value of the probability distribution</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Truncated_gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> \
                <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> \
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF2&quot;</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                       <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                       <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> \
                       <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> \
                       <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">k</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                        <span class="o">/</span> <span class="p">((</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                        <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> \
                        <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> \
                        <span class="o">/</span> <span class="p">((</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uninformative&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Above&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Below&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised distribution: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">error_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an error bar based on the distribution.  This</span>
<span class="sd">        does not necessarily correspond to the one-sigma value</span>
<span class="sd">        but rather to what is the most convenient value.</span>

<span class="sd">        :return: the error bar</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Truncated_gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF1&quot;</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> \
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">mean1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> \
                    <span class="o">*</span> <span class="n">k</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">mean2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> \
                    <span class="o">*</span> <span class="n">k</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean2</span> <span class="o">-</span> <span class="n">mean1</span> <span class="o">*</span> <span class="n">mean1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF2&quot;</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                       <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                       <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> \
                       <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> \
                       <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
            <span class="n">mean1</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                         <span class="o">/</span> <span class="p">((</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                         <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> \
                         <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> \
                         <span class="o">/</span> <span class="p">((</span><span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
            <span class="n">mean2</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                         <span class="o">/</span> <span class="p">((</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> \
                         <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> \
                         <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> \
                         <span class="o">/</span> <span class="p">((</span><span class="mf">3.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean2</span> <span class="o">-</span> <span class="n">mean1</span> <span class="o">*</span> <span class="n">mean1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uninformative&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Above&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Below&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised distribution: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of relevant parameters for a given distribution.</span>

<span class="sd">        :return: the number of relevant parameters</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Truncated_gaussian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;IMF2&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Uninformative&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Above&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Below&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="Distribution.print_me">
<a class="viewcode-back" href="../AIMS.html#AIMS.Distribution.print_me">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_me</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print type and parameters of probability distribution.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nparams</span><span class="p">]))</span></div>


<div class="viewcode-block" id="Distribution.to_string">
<a class="viewcode-back" href="../AIMS.html#AIMS.Distribution.to_string">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce nice string representation of the distribution.</span>

<span class="sd">        :return: nice string representation of the distribution</span>
<span class="sd">        :rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nparams</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="Prior_list">
<a class="viewcode-back" href="../AIMS.html#AIMS.Prior_list">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Prior_list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which contains a list of priors as well as convenient methods for</span>
<span class="sd">    adding priors and for evaluating them.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A list of probability distributions which correspond to priors.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Prior_list.add_prior">
<a class="viewcode-back" href="../AIMS.html#AIMS.Prior_list.add_prior">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aPrior</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a prior to the list.</span>

<span class="sd">        :param aPrior: prior which is to be added to the list.</span>
<span class="sd">        :type aPrior: :py:class:`Distribution`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aPrior</span><span class="p">)</span></div>


<div class="viewcode-block" id="Prior_list.realisation">
<a class="viewcode-back" href="../AIMS.html#AIMS.Prior_list.realisation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">realisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array with realisations for each prior.  The last dimension</span>
<span class="sd">        will correspond to the different priors.</span>

<span class="sd">        :param size: shape of random variates (for each prior)</span>
<span class="sd">        :type size: int or tuple of ints</span>

<span class="sd">        :return: a set of realisations</span>
<span class="sd">        :rtype: numpy float array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">prior</span><span class="o">.</span><span class="n">realisation</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">prior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">output_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">prior</span><span class="o">.</span><span class="n">realisation</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">prior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate ln of priors for a list of parameters.</span>

<span class="sd">        :param params: list of parameters which intervene in the priors.</span>
<span class="sd">        :type params: array-like</span>

<span class="sd">        :return: ln(prior probability)</span>
<span class="sd">        :rtype: float</span>

<span class="sd">        .. warning::</span>
<span class="sd">          The list of parameters should contain the same number of elements</span>
<span class="sd">          as the number of priors.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">log0</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">)),</span> <span class="s2">&quot;Incorrect number of parameters in call to Log_prior&quot;</span>
        <span class="n">lnprior</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">aPrior</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">lnprior</span> <span class="o">+=</span> <span class="n">aPrior</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lnprior</span></div>



<div class="viewcode-block" id="Mode">
<a class="viewcode-back" href="../AIMS.html#AIMS.Mode">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Mode</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which describes an *observed* pulsation mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_n</span><span class="p">,</span> <span class="n">_l</span><span class="p">,</span> <span class="n">_freq</span><span class="p">,</span> <span class="n">_dfreq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param _n: radial order of observed mode</span>
<span class="sd">        :param _l: harmonic degree of observed mode.</span>
<span class="sd">        :param _freq: pulsation frequency (in :math:`\\mathrm{\\mu Hz}`).</span>
<span class="sd">        :param _dfreq: error bar on pulsation frequency (in :math:`\\mathrm{\\mu Hz}`).</span>

<span class="sd">        :type _n: int</span>
<span class="sd">        :type _l: int</span>
<span class="sd">        :type _freq: float</span>
<span class="sd">        :type _dfreq: float</span>

<span class="sd">        .. warning::</span>
<span class="sd">          Negative values are not accepted for ``_l``, ``_freq``, or ``_dfreq``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check inputs</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">_l</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Modes with l &lt; 0 do not exist&quot;</span>
        <span class="k">assert</span> <span class="p">((</span><span class="n">_n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">_l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)),</span> <span class="s2">&quot;Radial g-modes do not exist&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">_freq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;I don&#39;t accept modes with negative frequencies&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">_dfreq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;I don&#39;t accept modes with negative error bars&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">_n</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Radial order of observed mode.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">_l</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Harmonic degree of observed mode.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">_freq</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pulsation frequency (in :math:`\\mathrm{\\mu Hz}`).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">=</span> <span class="n">_dfreq</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Error bar on pulsation frequency (in :math:`\\mathrm{\\mu Hz}`).&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Mode.match">
<a class="viewcode-back" href="../AIMS.html#AIMS.Mode.match">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check to see if input mode has the same (n,l) values as the current mode.</span>

<span class="sd">        :param a_mode: input mode which is being compared with current mode.</span>
<span class="sd">        :type a_mode: :py:class:`Mode`</span>

<span class="sd">        :return: ``True`` if the input mode has the same (n,l) values as the</span>
<span class="sd">          current mode.</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="n">a_mode</span><span class="o">.</span><span class="n">l</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="n">a_mode</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Mode.print_me">
<a class="viewcode-back" href="../AIMS.html#AIMS.Mode.print_me">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_me</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the mode in a human readable form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n=</span><span class="si">%d</span><span class="s2">, l=</span><span class="si">%d</span><span class="s2">, freq=</span><span class="si">%.3f</span><span class="s2">, dfreq=</span><span class="si">%.2e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfreq</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="Combination">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Combination</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which contains indices and coefficients which represent</span>
<span class="sd">    a linear combination of frequencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Value of the linear combination of frequencies.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Indices in of the linear combination of frequencies.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coefficients of the linear combination of frequencies.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Combination.add_coeff">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination.add_coeff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">coeff</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append the given index and coefficient to the list of indices and</span>
<span class="sd">        coefficients.</span>

<span class="sd">        :param j: index of the mode</span>
<span class="sd">        :param coeff: coefficient used in the frequency combination</span>

<span class="sd">        :type j: int</span>
<span class="sd">        :type coeff: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span></div>


<div class="viewcode-block" id="Combination.find_values">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination.find_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the value associated with this frequency combination</span>
<span class="sd">        using the input frequencies.</span>

<span class="sd">        :param freq: list of frequencies</span>
<span class="sd">        :type freq: float array like</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="Combination.print_me">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination.print_me">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_me</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Print frequency combination. &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*******************&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">coeff</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="Combination_function">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination_function">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Combination_function</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which applies functions to linear frequency combinations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_function</span><span class="p">,</span> <span class="n">_gradient_function</span><span class="p">,</span> <span class="n">_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">_name</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Human-readable name of the frequency combination function&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Value of the frequency combination function at the observed frequencies.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">_offset</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Additive offset for the frequency combination function.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The gradient of the frequency combination function at the observed frequencies.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The frequency combinations which intervene in the function.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">_function</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The function which is applied to the frequency combinations.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gradient_function</span> <span class="o">=</span> <span class="n">_gradient_function</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The gradient of the function which is applied to the frequency combinations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Combination_function.add_combination">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination_function.add_combination">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_combination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combination</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append a frequency combination to this combination function.</span>

<span class="sd">        :param combination: a linear frequency combination</span>
<span class="sd">        :type combination: :py:class:`Combination`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span></div>


<div class="viewcode-block" id="Combination_function.find_values">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination_function.find_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the value and gradient of this frequency combination function for</span>
<span class="sd">        the input set of frequencies.</span>

<span class="sd">        :param freq: list of frequencies</span>
<span class="sd">        :type freq: float array like</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">combination</span><span class="o">.</span><span class="n">find_values</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_function</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="Combination_function.print_me">
<a class="viewcode-back" href="../AIMS.html#AIMS.Combination_function.print_me">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_me</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Print frequency combination function. &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value    = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gradient = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combinations</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Combination </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combinations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">print_me</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="Likelihood">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Likelihood</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which described the likelihood function and allows users to evaluate it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of pulsation modes (of type :py:class:`Mode`).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of constraints which intervene in the likelihood function.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nonconstraints</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of constraints which are only used during plotting and not used in the likelihood function.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Covariance matrix which intervenes when calculating frequency combinations.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">invcov</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inverse of covariance matrix, :py:data:`Likelihood.cov`.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This contains functions of frequency combinations.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Absolute weight to be applied to seismic constraints&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Absolute weight to be applied to classic constraints (incl. nu_max constraint).&quot;&quot;&quot;</span>

        <span class="c1"># the following variables are used for Fortran style optimisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvalues</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Array with the n values of the observed modes&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lvalues</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Array with the l values of the observed modes&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fvalues</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Array with the observed frequencies&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ncomb</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1D int array which specifies the number of frequency combinations within</span>
<span class="sd">        each frequency combination function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of terms in each frequency combination.  The index is a</span>
<span class="sd">        cumulative index that uniquely designates one of the frequency combinations</span>
<span class="sd">        from one of the frequency combination functions. It is also the same as</span>
<span class="sd">        the second index in the :py:data:`coeff` and :py:data:`indices` variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2D float array with the coefficients for each frequency</span>
<span class="sd">        combination. The indices are:</span>

<span class="sd">          1. The index of the term</span>
<span class="sd">          2. The cumulative index of the frequency combination</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2D int array with the mode indices for each frequency combination.</span>
<span class="sd">        The indices are:</span>

<span class="sd">          1. The index of the term</span>
<span class="sd">          2. The cumulative index of the frequency combination</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># the following variables are used in the WhoSGlAd method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inverse of R matrix from the WhoSGlAd method (see Eqs. (D.5) and (D.10)</span>
<span class="sd">        from Farnir et al. (2019))</span>

<span class="sd">        .. note::</span>
<span class="sd">           The first index corresponds to the p vector whereas the second index</span>
<span class="sd">           corresponds to the normalised q vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qk</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalised q vectors from the WhoSGlAd method (Farnir et al. 2019).</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Likelihood.find_weights_new">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.find_weights_new">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_weights_new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find absolute weights for seismic and classic constraints based on options</span>
<span class="sd">        in ``AIMS_configure.py``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nclassic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">nseismic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">find_weights</span><span class="p">(</span><span class="n">nclassic</span><span class="p">,</span> <span class="n">nseismic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">seismic_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">classic_weight</span></div>


<div class="viewcode-block" id="Likelihood.find_weights">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.find_weights">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find absolute weights for seismic and classic constraints based on options</span>
<span class="sd">        in ``AIMS_configure.py``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">weight_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">weight_option</span> <span class="o">==</span> <span class="s2">&quot;Absolute&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">seismic_weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">classic_weight</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">weight_option</span> <span class="o">==</span> <span class="s2">&quot;Relative&quot;</span><span class="p">):</span>
            <span class="n">nseismic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
            <span class="n">nclassic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nclassic</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nseismic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">classic_weight</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">weight_option</span> <span class="o">==</span> <span class="s2">&quot;Reduced&quot;</span><span class="p">):</span>
            <span class="n">nseismic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
            <span class="n">nclassic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nclassic</span> <span class="o">+</span> <span class="n">nseismic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nclassic</span> <span class="o">+</span> <span class="n">nseismic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">weight_option</span> <span class="o">==</span> <span class="s2">&quot;Reduced_bis&quot;</span><span class="p">):</span>
            <span class="n">nseismic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
            <span class="n">nclassic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nseismic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nclassic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown weight_option: &quot;</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">weight_option</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.sort_modes">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.sort_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sort_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort the modes.  The ordering will depend on the value of ``use_n`` from the</span>
<span class="sd">        ``AIMS_configure.py`` file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Likelihood.create_mode_arrays">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.create_mode_arrays">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_mode_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create arrays with mode parameters (n, l, freq), which can</span>
<span class="sd">        be interfaced with fortran methods more easily.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">size_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">size_obs</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ltype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">size_obs</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ntype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">size_obs</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ftype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size_obs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">l</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span></div>


<div class="viewcode-block" id="Likelihood.read_constraints">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.read_constraints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a file with pulsation data and constraints.</span>

<span class="sd">        :param filename: name of file with pulsation data.</span>
<span class="sd">        :param factor: multiplicative factor for pulsation frequencies.  Can</span>
<span class="sd">          be used for conversions.</span>

<span class="sd">        :type filename: string</span>
<span class="sd">        :type factor: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># read modes:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">obsfile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">obsfile</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># distinguish between constraints and input frequencies by detecting</span>
                <span class="c1"># whether the first line is a number or a string:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">is_number</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">read_n</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">):</span>
                            <span class="c1"># l, n, f, df</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">_n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">_l</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                   <span class="n">_freq</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                                   <span class="n">_dfreq</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">):</span>
                            <span class="c1"># l, f, df</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_l</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                   <span class="n">_freq</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                   <span class="n">_dfreq</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>  <span class="c1"># Non-constraint data</span>
                        <span class="n">add_constraint_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_nonconstraint</span>
                        <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># Remove leading -</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_constraint_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_constraint</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">is_number</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                        <span class="n">add_constraint_func</span><span class="p">((</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">Distribution</span><span class="p">(</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">,</span>
                                                          <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">to_float</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_constraint_func</span><span class="p">((</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">Distribution</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">to_float</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))))</span>

        <span class="c1"># print number of modes:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I found </span><span class="si">%d</span><span class="s2"> modes in </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">),</span> <span class="n">filename</span><span class="p">))</span>

        <span class="c1"># if the n values have not been provided, then they need to be guessed:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">read_n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guess_n</span><span class="p">()</span>

        <span class="c1"># this needs to be done so that self.find_map() works correctly:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_modes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_mode_arrays</span><span class="p">()</span></div>


<div class="viewcode-block" id="Likelihood.add_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a supplementary constraint to the list of constraints.</span>

<span class="sd">        :param constraint: supplementary constraint</span>
<span class="sd">        :type constraint: (string, :py:class:`Distribution`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">distribution</span><span class="p">)</span> <span class="o">=</span> <span class="n">constraint</span>

        <span class="c1"># look for single letter constraints and &quot;translate&quot; them to their full name:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Teff&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Luminosity&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Radius&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;M_H&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;log_g&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">distribution</span><span class="p">))</span></div>


<div class="viewcode-block" id="Likelihood.add_nonconstraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_nonconstraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_nonconstraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonconstraint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a supplementary constraint to the list of non-constraints.</span>

<span class="sd">        :param constraint: supplementary constraint</span>
<span class="sd">        :type constraint: (string, :py:class:`Distribution`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">distribution</span><span class="p">)</span> <span class="o">=</span> <span class="n">nonconstraint</span>

        <span class="c1"># look for single letter constraints and &quot;translate&quot; them to their full name:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Teff&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Luminosity&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Radius&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;M_H&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;log_g&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Non-constraint </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> already in constraints. Check input file.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nonconstraints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">distribution</span><span class="p">))</span></div>


<div class="viewcode-block" id="Likelihood.guess_dnu">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.guess_dnu">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">guess_dnu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_n</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Guess the large frequency separation based on the radial modes.</span>

<span class="sd">        :param with_n: specifies whether to use the n values</span>
<span class="sd">          already stored with each mode, when calculating the</span>
<span class="sd">          large frequency separation.</span>
<span class="sd">        :type with_n: boolean</span>

<span class="sd">        :return: the large frequency separation</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nmodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">with_n</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nmodes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># find index with mode order according to (l,freq):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">],</span> \
                              <span class="p">[</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">]))</span>  <span class="c1"># sorts by l, then freq</span>

            <span class="c1"># find minimun frequency difference between radial modes as</span>
            <span class="c1"># a first estimate of the large frequency separation:</span>
            <span class="n">min_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmodes</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">freq</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">freq</span>
                <span class="c1"># the following condition is &quot;nan-resistant&quot;:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">min_diff</span> <span class="o">&lt;</span> <span class="n">diff</span><span class="p">):</span>
                    <span class="n">min_diff</span> <span class="o">=</span> <span class="n">diff</span>

            <span class="c1"># easy exit:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">min_diff</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: cannot find large frequency separation&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># refine large frequency separation using a least squares approach</span>
        <span class="c1"># on the radial modes, using temporary radial orders based on the</span>
        <span class="c1"># previous estimate of the large frequency separation.</span>
        <span class="n">ntemp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">nnu</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">with_n</span><span class="p">)):</span>
                <span class="n">ntemp</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">freq</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_diff</span><span class="p">)))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">with_n</span><span class="p">):</span>
                <span class="n">ntemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">n</span>
            <span class="n">cnst</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">one</span> <span class="o">+=</span> <span class="n">cnst</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">ntemp</span>
            <span class="n">nn</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">ntemp</span> <span class="o">*</span> <span class="n">ntemp</span>
            <span class="n">nu</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">freq</span>
            <span class="n">nnu</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">freq</span> <span class="o">*</span> <span class="n">ntemp</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nn</span> <span class="o">*</span> <span class="n">one</span> <span class="o">-</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">nnu</span> <span class="o">*</span> <span class="n">one</span> <span class="o">-</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nn</span> <span class="o">*</span> <span class="n">one</span> <span class="o">-</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.guess_n">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.guess_n">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">guess_n</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Guess the radial order of the observed pulsations modes.</span>

<span class="sd">        This method uses the large frequency separation, as calculated with</span>
<span class="sd">        :py:meth:`guess_dnu`, to estimate the radial orders.  These orders are</span>
<span class="sd">        subsequently adjusted to avoid multiple modes with the same</span>
<span class="sd">        identification.  The resultant radial orders could be off by a constant</span>
<span class="sd">        offset, but this is not too problematic when computing frequency</span>
<span class="sd">        combinations or ratios.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># obtain large frequency separation</span>
        <span class="c1"># (and sort modes according to (l,freq))</span>
        <span class="n">dnu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_dnu</span><span class="p">(</span><span class="n">with_n</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dnu</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="c1"># assign radial orders</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="n">mode</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="n">dnu</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>

        <span class="c1"># avoid having two modes with the same n value:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">],</span> \
                          <span class="p">[</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">]))</span>  <span class="c1"># sorts by l, then freq</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">l</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">n</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">l</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Likelihood.assign_n">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.assign_n">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the radial orders based on proximity to theoretical frequencies</span>
<span class="sd">        from an input model.</span>

<span class="sd">        :param my_model: input model</span>
<span class="sd">        :type my_model: :py:class:`model.Model`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nmissing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to assign radial orders due to unmatched modes&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># assign radial orders</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">][</span><span class="n">mode_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span></div>


<div class="viewcode-block" id="Likelihood.clear_seismic_constraints">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.clear_seismic_constraints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_seismic_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This clears the seismic constraints.  Specifically, the list of seismic</span>
<span class="sd">        combinations, and associated covariance matrix and its inverse are</span>
<span class="sd">        reinitialised.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invcov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Likelihood.add_seismic_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_seismic_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_seismic_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add seismic contraints based on the keyword given in ``string``.</span>

<span class="sd">        :param string: keyword which specifies the type of constraint to be added.</span>
<span class="sd">          Current options include:</span>

<span class="sd">          - ``nu``: individual frequencies</span>
<span class="sd">          - ``nu0``: individual frequencies (radial modes only)</span>
<span class="sd">          - ``nu_min0``: radial mode with minimum frequency</span>
<span class="sd">          - ``nu_min1``: radial mode with second lowest frequency</span>
<span class="sd">          - ``nu_min2``: radial mode with third lowest frequency</span>
<span class="sd">          - ``r02``: :math:`r_{02}` frequency ratios</span>
<span class="sd">          - ``r01``: :math:`r_{01}` frequency ratios</span>
<span class="sd">          - ``r10``: :math:`r_{10}` frequency ratios</span>
<span class="sd">          - ``dnu``: individual large frequency separations (using all modes)</span>
<span class="sd">          - ``dnu0``: individual large frequency separations (using radial modes only)</span>
<span class="sd">          - ``d2nu``: second differences (using all modes)</span>
<span class="sd">          - ``avg_dnu``: average large frequency separation (using all modes)</span>
<span class="sd">          - ``avg_dnu0``: average large frequency separation (using radial modes only)</span>
<span class="sd">          - ``whosglad_dnu``: WhoSGlAd version of average large frequency separation (all modes)</span>
<span class="sd">          - ``whosglad_dnu0``: WhoSGlAd version of average large frequency separation (l=0 modes)</span>
<span class="sd">          - ``whosglad_dnu1``: WhoSGlAd version of average large frequency separation (l=1 modes)</span>
<span class="sd">          - ``whosglad_r01``: WhoSGlAd version of average r01 frequency ratio</span>
<span class="sd">          - ``whosglad_r02``: WhoSGlAd version of average r02 frequency ratio</span>
<span class="sd">          - ``whosglad_Delta01``: WhoSGlAd Delta01 seismic constraint</span>
<span class="sd">          - ``whosglad_Delta02``: WhoSGlAd Delta02 seismic constraint</span>
<span class="sd">          - ``whosglad_eps0``:  WhoSGlAd average frequency offset (l=0 modes)</span>
<span class="sd">          - ``whosglad_eps1``:  WhoSGlAd average frequency offset (l=1 modes)</span>
<span class="sd">          - ``whosglad_AHe``:  WhoSGlAd amplitude indicator for helium content</span>
<span class="sd">          - ``whosglad_Abcz``:  WhoSGlAd amplitude indicator for the base of the convection zone</span>

<span class="sd">        :type string: string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;nu_min&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_nu_min_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">target_ell</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_nu_min_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">target_ell</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">6</span><span class="p">:]))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;nu&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),),</span> <span class="n">target_ell</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;r02&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)),</span> <span class="n">den_list</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)),</span>
                                  <span class="n">target_ell</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;r01&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span>
                                  <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">)),</span> \
                                  <span class="n">den_list</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)),</span> <span class="n">target_ell</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;r10&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span>
                                  <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.125</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.125</span><span class="p">)),</span> \
                                  <span class="n">den_list</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)),</span> <span class="n">target_ell</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dnu&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)),</span> <span class="n">target_ell</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;d2nu&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_combinations</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">num_list</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;avg_dnu&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dnu_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">l_targets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dnu_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">l_targets</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">7</span><span class="p">:])])</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;whosglad_dnu&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">construct_whosglad_basis</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">12</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_whosglad_dnu_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">l_targets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_whosglad_dnu_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">l_targets</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">12</span><span class="p">:])])</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;whosglad_r0&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown type of seismic constraint: &quot;</span> <span class="o">+</span> <span class="n">string</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping ...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">construct_whosglad_basis</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_whosglad_ratio_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">l_target</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">11</span><span class="p">:]))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;whosglad_Delta0&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown type of seismic constraint: &quot;</span> <span class="o">+</span> <span class="n">string</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping ...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">construct_whosglad_basis</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_whosglad_Delta_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">l_target</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">15</span><span class="p">:]))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;whosglad_eps&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">12</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown type of seismic constraint: &quot;</span> <span class="o">+</span> <span class="n">string</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping ...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">construct_whosglad_basis</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_whosglad_epsilon_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">l_target</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">12</span><span class="p">:]))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;whosglad_AHe&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">construct_whosglad_basis</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_whosglad_AHe_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;whosglad_Abcz&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">construct_whosglad_basis</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_whosglad_Abcz_constraint</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown type of seismic constraint: &quot;</span> <span class="o">+</span> <span class="n">string</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping ...&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Likelihood.find_l_list">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.find_l_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_l_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_targets</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find a list of l values with the following properties:</span>

<span class="sd">        - each l value only occurs once</span>
<span class="sd">        - each l value given in the parameter ``l_targets`` is</span>
<span class="sd">          in the result l list, except if there is less than npowers</span>
<span class="sd">          modes with this l value</span>
<span class="sd">        - if the parameter ``l_targets`` is ``None``, look for</span>
<span class="sd">          all l values with npowers or more modes associated with</span>
<span class="sd">          them</span>

<span class="sd">        :param l_targets: input list of l values</span>
<span class="sd">        :type l_targets: list of int</span>

<span class="sd">        :param npowers: the number of powers in the fit</span>
<span class="sd">        :type npowers: int</span>

<span class="sd">        :return: new list of l values with the above properties</span>
<span class="sd">        :rtype: list of int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># copy l_targets list to avoid modifying argument.  Make sure</span>
        <span class="c1"># each l value only occurs once in the copy.  Also, handle</span>
        <span class="c1"># the case l_targets is None:</span>
        <span class="n">l_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l_targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">):</span>
                    <span class="n">l_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">l_targets</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">):</span>
                    <span class="n">l_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

        <span class="c1"># count the number of modes with different l values</span>
        <span class="n">l_num</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">):</span>
                <span class="n">l_num</span><span class="p">[</span><span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># remove l values from list if there are less than 2 modes with</span>
        <span class="c1"># that value (iterate backwards to avoid problems with shifting</span>
        <span class="c1"># indices).</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">npowers</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">l_num</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">l_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">l_list</span></div>


<div class="viewcode-block" id="Likelihood.add_dnu_constraint_matrix">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_dnu_constraint_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_dnu_constraint_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">l_targets</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the large frequency separation as a contraint.  The coefficients</span>
<span class="sd">        are obtained via a least-squares approach.  The approach taken here</span>
<span class="sd">        has two advantages:</span>

<span class="sd">        1. Correlations between the large frequency separation and other</span>
<span class="sd">           seismic constraints will be taken into account.</span>
<span class="sd">        2. The same modes will be used in the same way, both for the</span>
<span class="sd">           observations and the models.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :param l_targets: specifies for which l values the large frequency</span>
<span class="sd">          separation is to be calculated.  If ``None`` is supplied, all</span>
<span class="sd">          modes will be used.</span>
<span class="sd">        :type string: string</span>
<span class="sd">        :type l_targets: list of int</span>

<span class="sd">        .. note::</span>
<span class="sd">          This uses a matrix approach and is therefore *not* the</span>
<span class="sd">          prefered method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">l_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="n">l_targets</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to find large frequency separation for given l targets.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Try including other l values in l_targets, or expanding your set of&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;observations.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># set up linear system and invert it:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cnst</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">dfreq</span><span class="p">)</span>
            <span class="n">ndx</span> <span class="o">=</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span>
            <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span>
            <span class="n">v</span><span class="p">[</span><span class="n">ndx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">invmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>

        <span class="c1"># create associated mode combination</span>
        <span class="n">a_combination</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">ndx</span> <span class="o">=</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">a_combination</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">invmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">invmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndx</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity_gradient</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_dnu_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_dnu_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_dnu_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">l_targets</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the large frequency separation as a contraint.  The coefficients</span>
<span class="sd">        are obtained via a least-squares approach.  The approach taken here</span>
<span class="sd">        has two advantages:</span>

<span class="sd">        1. Correlations between the large frequency separation and other</span>
<span class="sd">           seismic constraints will be taken into account.</span>
<span class="sd">        2. The same modes will be used in the same way, both for the</span>
<span class="sd">           observations and the models.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :param l_targets: specifies for which l values the large frequency</span>
<span class="sd">          separation is to be calculated.  If ``None`` is supplied, all</span>
<span class="sd">          modes will be used.</span>
<span class="sd">        :type string: string</span>
<span class="sd">        :type l_targets: list of int</span>

<span class="sd">        .. note::</span>
<span class="sd">          This uses an analytical approach and is therefore the</span>
<span class="sd">          prefered method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">l_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="n">l_targets</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to find large frequency separation for given l targets.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Try including other l values in l_targets, or expanding your set of&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;observations.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># find various summed quantities:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cnst</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">dfreq</span><span class="p">)</span>
            <span class="n">ndx</span> <span class="o">=</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
            <span class="n">m</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span>
            <span class="n">m</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span>
            <span class="n">nn</span> <span class="o">+=</span> <span class="n">cnst</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span>

        <span class="n">det</span> <span class="o">=</span> <span class="n">nn</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">det</span> <span class="o">-=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># create associated mode combination</span>
        <span class="n">a_combination</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">ndx</span> <span class="o">=</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">det</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">a_combination</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>

        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity_gradient</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_nu_min_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_nu_min_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_nu_min_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">target_ell</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_n</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the minimun frequencies/modes of a specific ell value as a seismic</span>
<span class="sd">        constraint.  Typically, such constraints are used as an &quot;anchor&quot;</span>
<span class="sd">        when combined with constraints based on frequency ratios.</span>

<span class="sd">        :param string: name of the seismic constraint</span>
<span class="sd">        :param target_ell: ell value of the minimum frequency/mode</span>
<span class="sd">        :param pos: position of desired frequency (0 = lowest, 1 = second lowest ...)</span>
<span class="sd">        :param min_n: if ``False``, look for minimum observational</span>
<span class="sd">          frequency.  If ``True``, look for minimum radial order.</span>

<span class="sd">        :type string: string</span>
<span class="sd">        :type target_ell: int</span>
<span class="sd">        :type pos: int</span>
<span class="sd">        :type min_n: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ndx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">min_n</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">]))</span>

        <span class="n">ipos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ndx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="n">target_ell</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">ipos</span><span class="p">):</span>
                <span class="n">ndx</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="n">ipos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ndx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ERROR: mode number </span><span class="si">%d</span><span class="s2"> for l=</span><span class="si">%d</span><span class="s2"> does not exist&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">target_ell</span><span class="p">))</span>

        <span class="n">a_combination</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
        <span class="n">a_combination</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">ndx</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity_gradient</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_combinations">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_combinations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">num_list</span><span class="p">,</span> <span class="n">den_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">target_ell</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This finds the indices of modes which intervene in a frequency combination or</span>
<span class="sd">        ratio, as specified by the mandatory and optional arguments.  These indices,</span>
<span class="sd">        the relevant coefficients, the numerator, the denominator, and the resultant</span>
<span class="sd">        value of the combination are stored in the :py:data:`combination_functions`</span>
<span class="sd">        variable.</span>

<span class="sd">        :param string: name of the frequency combination</span>
<span class="sd">        :param num_list: list of relative mode identifications and coefficients used</span>
<span class="sd">          to define a frequency combination or the numerator of a frequency ratio.</span>
<span class="sd">          This list contains tuples of the form (delta n, delta l, coeff).</span>
<span class="sd">        :param den_list: list of relative mode identifications and coefficients used</span>
<span class="sd">          to define the denominator of a frequency ratio.  If absent, then, it is</span>
<span class="sd">          assumed that a linear combination of frequencies is represented.  The form</span>
<span class="sd">          is the same as for ``num_list``.</span>
<span class="sd">        :param target_ell: this is used to impose a specific l value on the first</span>
<span class="sd">          selected mode.</span>

<span class="sd">        :type string: string</span>
<span class="sd">        :type num_list: list of (int,int,float)</span>
<span class="sd">        :type den_list: list of (int,int,float)</span>
<span class="sd">        :type target_ell: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># find indices of modes which follow the specified pattern</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">target_ell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="n">target_ell</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="n">a_combination_num</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
            <span class="n">skipMode</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">n_diff</span><span class="p">,</span> <span class="n">l_diff</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span> <span class="ow">in</span> <span class="n">num_list</span><span class="p">:</span>
                <span class="n">target_mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">n_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">l_diff</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">target_mode</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                        <span class="n">a_combination_num</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skipMode</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">skipMode</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">a_combination_den</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">n_diff</span><span class="p">,</span> <span class="n">l_diff</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span> <span class="ow">in</span> <span class="n">den_list</span><span class="p">:</span>
                <span class="n">target_mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">n_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">l_diff</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">target_mode</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                        <span class="n">a_combination_den</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skipMode</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">skipMode</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">den_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity</span><span class="p">,</span>
                                                              <span class="n">functions</span><span class="o">.</span><span class="n">identity_gradient</span><span class="p">)</span>
                <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_num</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">functions</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span>
                                                              <span class="n">functions</span><span class="o">.</span><span class="n">ratio_gradient</span><span class="p">)</span>
                <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_num</span><span class="p">)</span>
                <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_den</span><span class="p">)</span>

            <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">))</span></div>


<div class="viewcode-block" id="Likelihood.dot_product_whosglad">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.dot_product_whosglad">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dot_product_whosglad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dot product used for constructing an orthonormal set of seismic indicators</span>
<span class="sd">        using the WhoSGlAd method (Farnir et al. 2019).</span>

<span class="sd">        :param v1: a vector of frequencies (or some polynomial of the radial order)</span>
<span class="sd">        :type v1: float np.array</span>

<span class="sd">        :param v2: a vector of frequencies (or some polynomial of the radial order)</span>
<span class="sd">        :type v2: float np.array</span>

<span class="sd">        :return: the dot product between v1 and v2</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Likelihood.construct_whosglad_basis">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.construct_whosglad_basis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct_whosglad_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxpower</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">glitchpower</span><span class="o">=-</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct orthogonal basis for the smooth component of a pulsation spectrum</span>
<span class="sd">        using the Gram-Schmidt orthonormalisation method as described in the WhoSGlAd</span>
<span class="sd">        method (Farnir et al. 2019).</span>

<span class="sd">        :param maxpower: maximum power in Pj(n)=n^j polynomial</span>
<span class="sd">        :type maxpower: int</span>

<span class="sd">        :param glitchpower: lower power used in Helium glitch component</span>
<span class="sd">        :type glitchpower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="n">l_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">6</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">nt</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="n">l</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">**</span> <span class="n">k</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nl</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">ntilde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">l</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_He</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">**</span> <span class="n">glitchpower</span>
            <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_He</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">**</span> <span class="n">glitchpower</span>
            <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_He</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">**</span> <span class="p">(</span><span class="n">glitchpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_He</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">**</span> <span class="p">(</span><span class="n">glitchpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_BCZ</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">**</span> <span class="o">-</span><span class="mf">2.0</span>
            <span class="n">pk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_BCZ</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntilde</span> <span class="o">**</span> <span class="o">-</span><span class="mf">2.0</span>

        <span class="n">Rkk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nt</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nt</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">nt</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">Rkk</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dot_product_whosglad</span><span class="p">(</span><span class="n">pk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">Rkk</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dot_product_whosglad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">aux</span>
            <span class="n">Rkk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dot_product_whosglad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">pk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">Rkk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">Rkk</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">Rkk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="c1"># sanity check:</span>
        <span class="n">freq_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">freq_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">akl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dot_product_whosglad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">freq_vec</span><span class="p">)</span>
            <span class="n">freq_fit</span> <span class="o">+=</span> <span class="n">akl</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dfreq1</span> <span class="o">=</span> <span class="n">freq_fit</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freq_vec</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">dfreq2</span> <span class="o">=</span> <span class="n">freq_fit</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freq_vec</span><span class="p">)</span>
        <span class="n">dfreq3</span> <span class="o">=</span> <span class="n">freq_fit</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freq_vec</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WhoSGlAd chi2(smooth): </span><span class="si">%e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dot_product_whosglad</span><span class="p">(</span><span class="n">dfreq1</span><span class="p">,</span> <span class="n">dfreq1</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WhoSGlAd chi2(He):     </span><span class="si">%e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dot_product_whosglad</span><span class="p">(</span><span class="n">dfreq2</span><span class="p">,</span> <span class="n">dfreq2</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WhoSGlAd chi2(He+BCZ): </span><span class="si">%e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dot_product_whosglad</span><span class="p">(</span><span class="n">dfreq3</span><span class="p">,</span> <span class="n">dfreq3</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Likelihood.add_whosglad_dnu_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_whosglad_dnu_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_whosglad_dnu_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">l_targets</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maxpower</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an average large frequency separation as a contraint using the WhoSGlAd</span>
<span class="sd">        method (Farnir et al. 2019).  This approach has the advantage of leading to</span>
<span class="sd">        (near) orthogonal seismic indicators.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :type string: string</span>

<span class="sd">        :param l_targets: specifies for which l values the large frequency</span>
<span class="sd">          separation is to be calculated.  If ``None`` is supplied, all</span>
<span class="sd">          modes will be used.</span>
<span class="sd">        :type l_targets: list of int</span>

<span class="sd">        :param maxpower: maximum power in Pj(n)=n^j polynomial</span>
<span class="sd">        :type maxpower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">l_list_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">l_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="n">l_targets</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to add WhoSGlAd large separation constraint.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Try adding observed frequencies.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">a_combination</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ndx</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_list_ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">a_combination</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_list_ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">]</span>

            <span class="n">den</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">ndx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">den</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">num</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">ndx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="n">num</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">a_combination</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span>

        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">identity_gradient</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_whosglad_ratio_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_whosglad_ratio_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_whosglad_ratio_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">l_target</span><span class="p">,</span> <span class="n">maxpower</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an average frequency ratio as a contraint using the WhoSGlAd</span>
<span class="sd">        method (Farnir et al. 2019).  This approach has the advantage of</span>
<span class="sd">        leading to (near) orthogonal seismic indicators.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :type string: string</span>

<span class="sd">        :param l_target: specifies for which l to calculate the average</span>
<span class="sd">          frequency ratio.</span>
<span class="sd">        :type l_target: int</span>

<span class="sd">        :param maxpower: maximum power in Pj(n)=n^j polynomial</span>
<span class="sd">        :type maxpower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">l_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to add WhoSGlAd ratio constraint using l=0.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Please try a different constraint ...&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">l_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to add WhoSGlAd ratio constraint.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Try adding observed frequencies.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">ndx0</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ndxl</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l_target</span><span class="p">)</span>
        <span class="n">a_combination_num</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
        <span class="n">a_combination_den</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">a_combination_num</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndx0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx0</span><span class="p">,</span> <span class="n">ndx0</span><span class="p">]</span> \
                                            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndxl</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndxl</span><span class="p">,</span> <span class="n">ndxl</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">a_combination_den</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndx0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndx0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> \
                                        <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">l_target</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndxl</span><span class="p">,</span> <span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> \
                 <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx0</span><span class="p">,</span> <span class="n">ndx0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndx0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> \
                                                      <span class="n">functions</span><span class="o">.</span><span class="n">ratio_gradient</span><span class="p">,</span> <span class="n">_offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_num</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_den</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_whosglad_Delta_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_whosglad_Delta_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_whosglad_Delta_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">l_target</span><span class="p">,</span> <span class="n">maxpower</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a ratio of large frequency separations as a contraint using</span>
<span class="sd">        the WhoSGlAd method (Farnir et al. 2019).  This approach has the</span>
<span class="sd">        advantage of leading to (near) orthogonal seismic indicators.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :type string: string</span>

<span class="sd">        :param l_target: specifies for which l to calculate the average</span>
<span class="sd">          Delta constraint.</span>
<span class="sd">        :type l_target: int</span>

<span class="sd">        :param maxpower: maximum power in Pj(n)=n^j polynomial</span>
<span class="sd">        :type maxpower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">l_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to add WhoSGlAd Delta constraint using l=0.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Please try a different constraint ...&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">l_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to add WhoSGlAd Delta constraint.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Try adding observed frequencies.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">ndx0</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ndxl</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l_target</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">a_combination_num</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
        <span class="n">a_combination_den</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">a_combination_num</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndxl</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndxl</span><span class="p">,</span> <span class="n">ndxl</span><span class="p">]</span> \
                                        <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">a_combination_den</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndx0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndx0</span><span class="p">,</span> <span class="n">ndx0</span><span class="p">]</span> \
                                        <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> \
                                                      <span class="n">functions</span><span class="o">.</span><span class="n">ratio_gradient</span><span class="p">,</span> <span class="n">_offset</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_num</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_den</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_whosglad_epsilon_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_whosglad_epsilon_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_whosglad_epsilon_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">l_target</span><span class="p">,</span> <span class="n">maxpower</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an average frequency offset as a contraint using the WhoSGlAd</span>
<span class="sd">        method (Farnir et al. 2019).  This approach has the advantage of</span>
<span class="sd">        leading to (near) orthogonal seismic indicators.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :type string: string</span>

<span class="sd">        :param l_target: specifies for which l to calculate the average</span>
<span class="sd">          epsilon offset.</span>
<span class="sd">        :type l_target: int</span>

<span class="sd">        :param maxpower: maximum power in Pj(n)=n^j polynomial</span>
<span class="sd">        :type maxpower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">l_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># easy exit:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">l_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unable to add WhoSGlAd epsilon constraint.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Try adding observed frequencies.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">ndxl</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l_target</span><span class="p">)</span>

        <span class="n">a_combination_num</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
        <span class="n">a_combination_den</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">a_combination_num</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndxl</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndxl</span><span class="p">,</span> <span class="n">ndxl</span><span class="p">]</span> \
                                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndxl</span><span class="p">,</span> <span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span>
                                            <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">a_combination_den</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rkkinv</span><span class="p">[</span><span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> \
                                        <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> \
                                                      <span class="n">functions</span><span class="o">.</span><span class="n">ratio_gradient</span><span class="p">,</span> <span class="n">_offset</span><span class="o">=-</span><span class="n">l_target</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_num</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination_den</span><span class="p">)</span>
        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_whosglad_AHe_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_whosglad_AHe_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_whosglad_AHe_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">maxpower</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a seismic constraint which provides a normalised He glitch amplitude</span>
<span class="sd">        using the WhoSGlAd method (Farnir et al. 2019).  This approach has the</span>
<span class="sd">        advantage of leading to (near) orthogonal seismic indicators.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :type string: string</span>

<span class="sd">        :param maxpower: maximum power in Pj(n)=n^j polynomial</span>
<span class="sd">        :type maxpower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">ndx</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> \
                                                      <span class="n">functions</span><span class="o">.</span><span class="n">norm_gradient</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">a_combination</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">a_combination</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination</span><span class="p">)</span>

        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.add_whosglad_Abcz_constraint">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.add_whosglad_Abcz_constraint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_whosglad_Abcz_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">maxpower</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a seismic constraint which provides a normalised glitch amplitude</span>
<span class="sd">        for the base of the convection zone using the WhoSGlAd method (Farnir</span>
<span class="sd">        et al. 2019).  This approach has the advantage of leading to (near)</span>
<span class="sd">        orthogonal seismic indicators.</span>

<span class="sd">        :param string: name of this seismic constraint</span>
<span class="sd">        :type string: string</span>

<span class="sd">        :param maxpower: maximum power in Pj(n)=n^j polynomial</span>
<span class="sd">        :type maxpower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">ndx</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_l_list</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">npowers</span><span class="o">=</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">4</span>

        <span class="n">a_combination_function</span> <span class="o">=</span> <span class="n">Combination_function</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> \
                                                      <span class="n">functions</span><span class="o">.</span><span class="n">norm_gradient</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">a_combination</span> <span class="o">=</span> <span class="n">Combination</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">a_combination</span><span class="o">.</span><span class="n">add_coeff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ndx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">a_combination_function</span><span class="o">.</span><span class="n">add_combination</span><span class="p">(</span><span class="n">a_combination</span><span class="p">)</span>

        <span class="n">a_combination_function</span><span class="o">.</span><span class="n">find_values</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_combination_function</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of added seismic constraints:  1&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.find_covariance">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.find_covariance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This prepares the covariance matrix and its inverse based on the frequency</span>
<span class="sd">        combinations in :py:data:`combination_functions`.</span>

<span class="sd">        .. warning::</span>
<span class="sd">          This method should be called *after* all of the methods which</span>
<span class="sd">          add to the list of frequency combinations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">vec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">vec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vec1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">invcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.find_vec">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.find_vec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_combination_function</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This finds a set of coefficients which intervene when constructing the</span>
<span class="sd">        coviance matrix for frequency combination functions.</span>

<span class="sd">        :param a_combination_function: variable which specifies the frequency</span>
<span class="sd">              combination function.</span>
<span class="sd">        :type a_combination_function: :py:class:`Combination_function`</span>

<span class="sd">        :return: the above set of coefficients</span>
<span class="sd">        :rtype: np.array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_combination_function</span><span class="o">.</span><span class="n">combinations</span><span class="p">)):</span>
            <span class="n">a_combination</span> <span class="o">=</span> <span class="n">a_combination_function</span><span class="o">.</span><span class="n">combinations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">vec_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a_combination</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">a_combination</span><span class="o">.</span><span class="n">coeff</span><span class="p">):</span>
                <span class="n">vec_temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coeff</span>

            <span class="n">vec</span> <span class="o">+=</span> <span class="n">a_combination_function</span><span class="o">.</span><span class="n">gradient</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec_temp</span>

        <span class="k">return</span> <span class="n">vec</span></div>


<div class="viewcode-block" id="Likelihood.create_combination_arrays">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.create_combination_arrays">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_combination_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create array form of frequency combination functions to be used with</span>
<span class="sd">        a fortran based routine for calculating the seismic chi^2 value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># combine all list of combinations:</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a_combination_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">:</span>
            <span class="n">combinations</span> <span class="o">+=</span> <span class="n">a_combination_function</span><span class="o">.</span><span class="n">combinations</span>

        <span class="c1"># find appropriate array dimensions:</span>
        <span class="n">nfunc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
        <span class="n">ncomb_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">:</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nmax</span> <span class="o">&lt;</span> <span class="n">n0</span><span class="p">):</span>
                <span class="n">nmax</span> <span class="o">=</span> <span class="n">n0</span>

        <span class="c1"># initialise arrays:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncomb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">acf</span><span class="o">.</span><span class="n">combinations</span><span class="p">)</span> <span class="k">for</span> <span class="n">acf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ncomb_total</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmax</span><span class="p">,</span> <span class="n">ncomb_total</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ftype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmax</span><span class="p">,</span> <span class="n">ncomb_total</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncomb_total</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">combinations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">combinations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.apply_constraints">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.apply_constraints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a :math:`\\chi^2` value for the set of constraints (excluding</span>
<span class="sd">        seismic constraints based on mode frequencies).</span>

<span class="sd">        :param my_model: model for which the :math:`\\chi^2` value is being calculated</span>
<span class="sd">        :type my_model: :py:class:`model.Model`</span>

<span class="sd">        :return: the :math:`\\chi^2` value deduced from classic constraints</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chi2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">distrib</span><span class="p">)</span> <span class="o">=</span> <span class="n">constraint</span>
            <span class="n">chi2</span> <span class="o">+=</span> <span class="n">distrib</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">chi2</span></div>


<div class="viewcode-block" id="Likelihood.find_map">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.find_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">,</span> <span class="n">use_n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This finds a map which indicates the correspondance between observed</span>
<span class="sd">        modes and theoretical modes from ``my_model``.</span>

<span class="sd">        :param my_model: model for which the :math:`\\chi^2` value is being calculated</span>
<span class="sd">        :param use_n: specify whether to use the radial order when finding the map</span>
<span class="sd">                     from observed modes to theoretical modes.  If ``False``, the map</span>
<span class="sd">                     is based on frequency proximity.</span>

<span class="sd">        :type m_model: :py:class:`model.Model`</span>
<span class="sd">        :type use_n: boolean</span>

<span class="sd">        :return: the correspondance between observed and theoretical modes from the</span>
<span class="sd">          above model, and the number of observed modes which weren&#39;t mapped onto</span>
<span class="sd">          theoretical modes</span>
<span class="sd">        :rtype: list of int, int</span>

<span class="sd">        .. note::</span>
<span class="sd">          - a value of -1 is used to indicate that no theoretical mode corresponds to</span>
<span class="sd">            a particular observed mode.</span>
<span class="sd">          - only zero or one observed mode is allowed to correspond to a theoretical</span>
<span class="sd">            mode</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mode_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># sanity checks:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mode_map</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mode_map</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">use_n</span><span class="p">):</span>  <span class="c1"># No, this is not a mistake - you wan&#39;t to use the local value of use_n, not the</span>
            <span class="c1"># one from AIMS_configure.py.</span>
            <span class="c1"># NOTE: this assumes the observed modes are sorted according to (l,n)</span>
            <span class="k">return</span> <span class="n">aims_fortran</span><span class="o">.</span><span class="n">find_map_n</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvalues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvalues</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span> \
                                           <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">],</span> <span class="n">mode_map</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: this assumes the observed modes are sorted according to (l,freq)</span>

            <span class="c1"># sorts by l, then freq</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">])))</span>

            <span class="k">return</span> <span class="n">aims_fortran</span><span class="o">.</span><span class="n">find_map_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fvalues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvalues</span><span class="p">,</span> \
                                              <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">],</span> \
                                              <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">],</span> <span class="n">ind</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">)</span></div>


<div class="viewcode-block" id="Likelihood.compare_frequency_combinations">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.compare_frequency_combinations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_frequency_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This finds a :math:`\\chi^2` value based on a comparison of frequency</span>
<span class="sd">        combination functions, as defined in the :py:data:`combination_function`</span>
<span class="sd">        variable.</span>

<span class="sd">        :param my_model: model for which the :math:`\\chi^2` value is being calculated</span>
<span class="sd">        :param mode_map: a mapping which relates observed modes to theoretical ones</span>
<span class="sd">        :param a: parameters of surface correction terms</span>

<span class="sd">        :type my_model: :py:class:`model.Model`</span>
<span class="sd">        :type mode_map: list of int</span>
<span class="sd">        :type a: array-like</span>

<span class="sd">        :return: the :math:`\\chi^2` value for the seismic constraints</span>
<span class="sd">        :rtype: float</span>

<span class="sd">        .. note::</span>
<span class="sd">          I&#39;m assuming none of the modes are missing (i.e. that mode_map doesn&#39;t</span>
<span class="sd">          contain the value -1)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># sanity check:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">freq</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_freq</span><span class="p">(</span><span class="n">surface_option</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">)</span> \
               <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ftype</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">aims_fortran</span><span class="o">.</span><span class="n">compare_frequency_combinations</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="n">nfunc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
        <span class="n">dvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfunc</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ftype</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfunc</span><span class="p">):</span>
            <span class="n">dvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomb</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> \
                         <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span> \
                         <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dvalues</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invcov</span><span class="p">,</span> <span class="n">dvalues</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span></div>


<div class="viewcode-block" id="Likelihood.get_optimal_surface_amplitudes">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.get_optimal_surface_amplitudes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_optimal_surface_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find optimal surface correction amplitude, for the surface correction</span>
<span class="sd">        specified by ``surface_option``.</span>

<span class="sd">        :param my_model: the model for which we&#39;re finding the surface correction amplitude</span>
<span class="sd">        :param mode_map: a mapping which relates observed modes to theoretical ones</span>

<span class="sd">        :type my_model: :py:class:`model.Model`</span>
<span class="sd">        :type mode_map: list of int</span>

<span class="sd">        :return: optimal surface correction amplitudes</span>
<span class="sd">        :rtype: np.array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>

        <span class="n">nsurf_free</span> <span class="o">=</span> <span class="n">nsurf</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008_2&quot;</span><span class="p">):</span>
            <span class="n">nsurf_free</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015_2&quot;</span><span class="p">):</span>
            <span class="n">nsurf_free</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsurf_free</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsurf_free</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsurf</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008_2&quot;</span><span class="p">):</span>
                <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015_2&quot;</span><span class="p">):</span>
                <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">beta_Sonoi2015</span>

            <span class="n">dsurf</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_surface_correction</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsurf</span><span class="p">[</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span> \
                    <span class="o">-</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">mode_map</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span>

        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsurf_free</span><span class="p">,</span> <span class="n">nsurf_free</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsurf_free</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsurf_free</span><span class="p">):</span>
            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Y</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nsurf_free</span><span class="p">):</span>
                <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

        <span class="c1"># if mat is singular, use np.linalg.lstsq(mat,b) instead</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="c1"># if need be, append the fixed parameter:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008_2&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015_2&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">beta_Sonoi2015</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Likelihood.evaluate">
<a class="viewcode-back" href="../AIMS.html#AIMS.Likelihood.evaluate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate ln of likelihood function (i.e. a :math:`\\chi^2` value) for a given</span>
<span class="sd">        model.</span>

<span class="sd">        :param my_model: model for which the :math:`\\chi^2` value is being calculated</span>
<span class="sd">        :type my_model: :py:class:`model.Model`</span>

<span class="sd">        :return: the :math:`\\chi^2` value, optionally the optimal surface amplitudes</span>
<span class="sd">           (depending on the value of :py:data:`AIMS_configure.surface_option`),</span>
<span class="sd">           integers to indicate whether the model was rejected due to classic</span>
<span class="sd">           or seismic contraints</span>
<span class="sd">        :rtype: float, np.array (optional), int, int</span>

<span class="sd">        .. note::</span>
<span class="sd">          This avoids model interpolation and can be used to gain time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chi2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">(</span><span class="n">my_model</span><span class="p">)</span>
        <span class="n">reject_classic</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chi2</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">reject_classic</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">read_n</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nmissing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">log0</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="mi">1</span>
                <span class="n">chi2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_frequency_combinations</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nmissing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">log0</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nsurf</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="mi">1</span>
                <span class="n">optimal_amplitudes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optimal_surface_amplitudes</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">)</span>
                <span class="n">chi2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_frequency_combinations</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">,</span>
                                                                                  <span class="n">a</span><span class="o">=</span><span class="n">optimal_amplitudes</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">optimal_amplitudes</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chi2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nsurf</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="mi">0</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate ln of likelihood function (i.e. a :math:`\\chi^2` value) for a given</span>
<span class="sd">        set of parameters.</span>

<span class="sd">        :param params: set of parmaeters for which the :math:`\\chi^2` value is being</span>
<span class="sd">          calculated.</span>
<span class="sd">        :type params: array-like</span>

<span class="sd">        :return: the :math:`\\chi^2` value</span>
<span class="sd">        :rtype: float</span>

<span class="sd">        .. note::</span>
<span class="sd">          If surface corrections are applied, then the last element(s)</span>
<span class="sd">          of params is/are assumed to be surface correction amplitude(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">log0</span>
        <span class="n">my_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">interpolate_model</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">tessellation</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">ndx</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">my_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">log0</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nmissing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">log0</span>
            <span class="n">chi2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_frequency_combinations</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">,</span>
                                                                              <span class="n">a</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">:</span><span class="n">ndims</span><span class="p">])</span>
        <span class="n">chi2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">(</span><span class="n">my_model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chi2</span></div>



<div class="viewcode-block" id="Probability">
<a class="viewcode-back" href="../AIMS.html#AIMS.Probability">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Probability</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which combines the priors and likelihood function, and allows the</span>
<span class="sd">    the user to evalute ln of the product of these.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_priors</span><span class="p">,</span> <span class="n">_likelihood</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param _priors: input set of priors</span>
<span class="sd">        :param _likelihood: input likelihood function</span>

<span class="sd">        :type _priors: :py:class:`Prior_list`</span>
<span class="sd">        :type _likelihood: :py:class:`Likelihood`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="n">_priors</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of priors.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">_likelihood</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The likelihood function.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Probability.evaluate">
<a class="viewcode-back" href="../AIMS.html#AIMS.Probability.evaluate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalulate the ln of the product of the priors and likelihood function,</span>
<span class="sd">        i.e. the probability, for a given model, to within an additive</span>
<span class="sd">        constant.</span>

<span class="sd">        :param my_model: input model</span>
<span class="sd">        :type my_model: :py:class:`model.Model`</span>

<span class="sd">        :return: the ln of the probability, integers indicating if the model has bee</span>
<span class="sd">                 rejected based on classic constraints, seismic constraints, and/or priors</span>
<span class="sd">        :rtype: float, int, int, int</span>

<span class="sd">        .. note::</span>
<span class="sd">          This avoids model interpolation and can be used to gain time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">result1</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="n">reject_seismic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">my_model</span><span class="p">)</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">grid_params_MCMC</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result1</span><span class="p">,</span> <span class="n">surf_amplitudes</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="n">reject_seismic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">my_model</span><span class="p">)</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">grid_params_MCMC</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">surf_amplitudes</span><span class="p">))</span>

        <span class="n">reject_prior</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result2</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">reject_prior</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">result1</span> <span class="o">+</span> <span class="n">result2</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> <span class="n">reject_seismic</span><span class="p">,</span> <span class="n">reject_prior</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evalulate the ln of the product of the priors and likelihood function,</span>
<span class="sd">        i.e. the probability, for a given model, to within an additive</span>
<span class="sd">        constant.</span>

<span class="sd">        :return: the ln of the probability</span>
<span class="sd">        :rtype: float</span>

<span class="sd">        :param params: input set of parameters</span>
<span class="sd">        :type params: array-like</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result1</span> <span class="o">+</span> <span class="n">result2</span>

<div class="viewcode-block" id="Probability.is_outside">
<a class="viewcode-back" href="../AIMS.html#AIMS.Probability.is_outside">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_outside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test to see if the given set of parameters lies outside the grid of</span>
<span class="sd">        models.  This is done by evaluate the probability and seeing if</span>
<span class="sd">        the result indicates this.</span>

<span class="sd">        :param params: input set of parameters</span>
<span class="sd">        :type params: array-like</span>

<span class="sd">        :return: ``True`` if the set of parameters corresponds to a point</span>
<span class="sd">           outside the grid.</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># the following condition is &quot;nan-resistant&quot;:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="check_configuration">
<a class="viewcode-back" href="../AIMS.html#AIMS.check_configuration">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_configuration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the version of the EMCEE package and set the mc2 variable accordingly.</span>

<span class="sd">    Test the values of the variables in check_configuration to make</span>
<span class="sd">    sure they&#39;re acceptable.  If an unacceptable value is found, then</span>
<span class="sd">    this will stop AIMS and explain what variable has an erroneous</span>
<span class="sd">    value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">mc2</span>
    <span class="n">emcee_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">emcee</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mc2</span> <span class="o">=</span> <span class="p">(</span><span class="n">emcee_version</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="p">((</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;nwalkers should be even.  Please modify AIMS_configure.py&quot;</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="write_binary_data">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_binary_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_binary_data</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read an ascii file with a grid of models, and write corresponding binary file.</span>

<span class="sd">    :param infile: input ascii file name</span>
<span class="sd">    :param outfile: output binary file name</span>

<span class="sd">    :type infile: string</span>
<span class="sd">    :type outfile: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model_grid</span><span class="p">()</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">read_model_list</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">replace_age_adim</span><span class="p">()</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">check_age_adim</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">distort_grid</span><span class="p">):</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">distort_grid</span><span class="p">()</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">tessellate</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="n">grid</span><span class="o">.</span><span class="n">plot_tessellation</span><span class="p">()</span></div>



<div class="viewcode-block" id="load_binary_data">
<a class="viewcode-back" href="../AIMS.html#AIMS.load_binary_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_binary_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a binary file with a grid of models.</span>

<span class="sd">    :param filename: name of file with grid in binary format</span>
<span class="sd">    :type filename: string</span>

<span class="sd">    :return: the grid of models</span>
<span class="sd">    :rtype: :py:class:`model.Model_grid`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_data</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="n">retessellate</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">remove_tracks</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">track_threshold</span><span class="p">)</span>  <span class="c1"># filter out incomplete tracks</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">distort_grid</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="s2">&quot;distort_mat&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">distort_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">grid</span><span class="o">.</span><span class="n">distort_grid</span><span class="p">()</span>
                <span class="n">retessellate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">distort_grid</span><span class="p">()</span>
            <span class="n">retessellate</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="s2">&quot;distort_mat&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">distort_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">grid</span><span class="o">.</span><span class="n">distort_mat</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">retessellate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">distort_mat</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">retessellate</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">retessellate</span><span class="p">):</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">tessellate</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">user_params</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: mismatch between the user_params in the binary grid file&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         and in AIMS_configure.py.  Will overwrite user_params.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Binary grid file:  &quot;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  AIMS_configure.py: &quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>

        <span class="c1"># manually correct relevant variables:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">user_params</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">user_params</span>
        <span class="n">model</span><span class="o">.</span><span class="n">nglb</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">nlin</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">iradius</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">iluminosity</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">init_user_param_dict</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">grid</span></div>



<div class="viewcode-block" id="write_list_file">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_list_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_list_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write list file from which to generate binary grid.  Various filters</span>
<span class="sd">    can be included to reduce the number of models.</span>

<span class="sd">    .. note::</span>
<span class="sd">      This code is intended for developpers, not first time users.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># write results to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">postfix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
            <span class="c1"># if (int(round(track.params[0]*100.0))%4 != 0): continue # impose step of 0.04 Msun</span>
            <span class="c1"># if (int(round(track.params[1]*100.0))%10 != 0): continue # impose step of 0.1 on alpha_MLT</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
                <span class="c1"># no need to copy the modes since they are not used</span>
                <span class="n">amodel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_name</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%20s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>  <span class="c1"># the filename</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">imass</span><span class="p">]))</span>  <span class="c1"># the mass (in g)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iradius</span><span class="p">]))</span>  <span class="c1"># the radius (in cm)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iluminosity</span><span class="p">]))</span>  <span class="c1"># the luminosity (in erg/s)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iz0</span><span class="p">]))</span>  <span class="c1"># the Z0</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ix0</span><span class="p">]))</span>  <span class="c1"># the X0</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iage</span><span class="p">]))</span>  <span class="c1"># the age (in Myrs)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%16.10f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">itemperature</span><span class="p">]))</span>  <span class="c1"># the effective temperature (in K)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%7.5f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;alpha_MLT&quot;</span><span class="p">)))</span>  <span class="c1"># the mixing length</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Zs&quot;</span><span class="p">)))</span>  <span class="c1"># the Zs</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Xs&quot;</span><span class="p">)))</span>  <span class="c1"># the Xs</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Zc&quot;</span><span class="p">)))</span>  <span class="c1"># the Zc</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Xc&quot;</span><span class="p">)))</span>  <span class="c1"># the Xc</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Tc&quot;</span><span class="p">)))</span>  <span class="c1"># the central temperature</span></div>



<div class="viewcode-block" id="write_SPInS_file_cgs">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_SPInS_file_cgs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_SPInS_file_cgs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write list file compatible with SPInS.  The quantities mass, luminosity, and radius</span>
<span class="sd">    are provided in cgs.</span>

<span class="sd">    .. note::</span>
<span class="sd">      The header in the output file might need to be edited by hand.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># write results to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;# [&#39;Age_adim&#39;, &#39;Age&#39;, &#39;Mass&#39;, &#39;Luminosity&#39;, &#39;Teff&#39;, &#39;Radius&#39;, &#39;Z&#39;, &#39;Y&#39;, &#39;g&#39;, &#39;Dnu&#39;, &#39;numax&#39;, &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">user_params</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &#39;</span><span class="si">%s</span><span class="s2">&#39;,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elt</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;# [r&#39;Age parameter, $\tau$&#39;, r&#39;Age, $t$ (Myrs)&#39;, r&#39;Mass, $M$ (g)&#39;, r&#39;Luminosity, $L$ (erg.s$^{-1}$)&#39;, r&#39;Effective temperature, $T_{\mathrm</span><span class="si">{eff}</span><span class="s2">}$ (K)&#39;, r&#39;Radius, $R$ (cm)&#39;, r&#39;Metallicity, $Z$&#39;, r&#39;Helium content, $Y$&#39;, r&#39;Surface gravity, $g$ (cm.s$^{-2}$)&#39;, r&#39;Large separation, $\Delta\nu$ ($\mu$Hz)&#39;, r&#39;$\nu_{\mathrm</span><span class="si">{max}</span><span class="s2">}$ ($\mu$Hz)&#39;,&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">user_params</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; r&#39;</span><span class="si">%s</span><span class="s2">&#39;,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_params</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">nuser</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
                <span class="c1"># no need to copy the modes since they are not used</span>
                <span class="n">amodel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_name</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">_modes</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">track</span><span class="o">.</span><span class="n">mode_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">track</span><span class="o">.</span><span class="n">mode_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iage_adim</span><span class="p">]))</span>  <span class="c1"># dimensionless age parameter</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iage</span><span class="p">]))</span>  <span class="c1"># the age (in Myrs)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">imass</span><span class="p">]))</span>  <span class="c1"># the mass (in g)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iluminosity</span><span class="p">]))</span>  <span class="c1"># the luminosity (in erg/s)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%16.10f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">itemperature</span><span class="p">]))</span>  <span class="c1"># the effective temperature (K)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iradius</span><span class="p">]))</span>  <span class="c1"># the radius (in cm)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iz0</span><span class="p">]))</span>  <span class="c1"># the Z0</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ix0</span><span class="p">]))</span>  <span class="c1"># the X0</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)))</span>  <span class="c1"># surface gravity (in cm/s^2)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Dnu&quot;</span><span class="p">)))</span>  <span class="c1"># large separation (in muHz)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;numax&quot;</span><span class="p">)))</span>  <span class="c1"># nu_max (in muHz)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nuser</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">i</span><span class="p">]))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_SPInS_file_solar">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_SPInS_file_solar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_SPInS_file_solar</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write list file compatible with SPInS.  The quantities mass, luminosity, and radius</span>
<span class="sd">    are provided solar units.</span>

<span class="sd">    .. note::</span>
<span class="sd">      The header in the output file might need to be edited by hand.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># write results to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;# [&#39;Age_adim&#39;, &#39;Age&#39;, &#39;Mass&#39;, &#39;Luminosity&#39;, &#39;Teff&#39;, &#39;Radius&#39;, &#39;Z&#39;, &#39;Y&#39;, &#39;g&#39;, &#39;Dnu&#39;, &#39;numax&#39;, &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">user_params</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &#39;</span><span class="si">%s</span><span class="s2">&#39;,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elt</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;# [r&#39;Age parameter, $\tau$&#39;, r&#39;Age, $t$ (Myrs)&#39;, r&#39;Mass, $M/M_{\odot}$&#39;, r&#39;Luminosity, $L/L_{\odot}$&#39;, r&#39;Effective temperature, $T_{\mathrm</span><span class="si">{eff}</span><span class="s2">}$ (K)&#39;, r&#39;Radius, $R/R_{\odot}$&#39;, r&#39;Metallicity, $Z$&#39;, r&#39;Helium content, $Y$&#39;, r&#39;Surface gravity, $g$ (cm.s$^{-2}$)&#39;, r&#39;Large separation, $\Delta\nu$ ($\mu$Hz)&#39;, r&#39;$\nu_{\mathrm</span><span class="si">{max}</span><span class="s2">}$ ($\mu$Hz)&#39;,&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">user_params</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; r&#39;</span><span class="si">%s</span><span class="s2">&#39;,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_params</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">nuser</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
                <span class="c1"># no need to copy the modes since they are not used</span>
                <span class="n">amodel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_name</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">_modes</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">track</span><span class="o">.</span><span class="n">mode_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">track</span><span class="o">.</span><span class="n">mode_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iage_adim</span><span class="p">]))</span>  <span class="c1"># dimensionless age</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iage</span><span class="p">]))</span>  <span class="c1"># the age (in Myrs)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">)))</span>  <span class="c1"># the mass (in Msun)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Luminosity&quot;</span><span class="p">)))</span>  <span class="c1"># the luminosity (in Lsun)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%16.10f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">itemperature</span><span class="p">]))</span>  <span class="c1"># Teff (K)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Radius&quot;</span><span class="p">)))</span>  <span class="c1"># the radius (in Rsun)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iz0</span><span class="p">]))</span>  <span class="c1"># the Z0</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%17.15f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ix0</span><span class="p">]))</span>  <span class="c1"># the X0</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)))</span>  <span class="c1"># surface g (in cm/s^2)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Dnu&quot;</span><span class="p">)))</span>  <span class="c1"># Delta nu (in muHz)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;numax&quot;</span><span class="p">)))</span>  <span class="c1"># nu_max (in muHz)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nuser</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">i</span><span class="p">]))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_best_model">
<a class="viewcode-back" href="../AIMS.html#AIMS.find_best_model">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_best_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scan through grid of models to find &quot;best&quot; model for a given probability</span>
<span class="sd">    function (i.e. the product of priors and a likelihood function).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">aux</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">))</span>
    <span class="c1"># find best models in each track, in a parallelised way:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">my_map</span><span class="p">(</span><span class="n">find_best_model_in_track</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">best_grid_model</span><span class="p">,</span> <span class="n">best_grid_params</span><span class="p">,</span> <span class="n">best_grid_result</span><span class="p">,</span> <span class="n">best_age_range</span>
    <span class="k">global</span> <span class="n">accepted_parameters</span><span class="p">,</span> <span class="n">rejected_parameters</span>
    <span class="k">global</span> <span class="n">nreject_classic</span><span class="p">,</span> <span class="n">nreject_seismic</span><span class="p">,</span> <span class="n">nreject_prior</span>

    <span class="n">best_grid_result</span> <span class="o">=</span> <span class="n">log0</span>
    <span class="n">best_grid_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">accepted_parameters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rejected_parameters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nreject_classic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nreject_seismic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nreject_prior</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">accepted</span><span class="p">,</span> <span class="n">rejected</span><span class="p">,</span> <span class="n">age_range</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">accepted_parameters</span> <span class="o">+=</span> <span class="n">accepted</span>
        <span class="n">rejected_parameters</span> <span class="o">+=</span> <span class="n">rejected</span>
        <span class="n">nreject_classic</span> <span class="o">+=</span> <span class="n">rc</span>
        <span class="n">nreject_seismic</span> <span class="o">+=</span> <span class="n">rs</span>
        <span class="n">nreject_prior</span> <span class="o">+=</span> <span class="n">rp</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">best_grid_result</span><span class="p">):</span>
            <span class="n">best_grid_result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">best_grid_model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="n">best_age_range</span> <span class="o">=</span> <span class="n">age_range</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of accepted models: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accepted_parameters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of rejected models: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_parameters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Rejections from classic constraints: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nreject_classic</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Rejections from seismic constraints: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nreject_seismic</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Rejections based on priors:          </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nreject_prior</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">best_grid_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to find a model in the grid that matches your constraints.&quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;Try extending your models&#39; frequency spectra.&quot;</span><span class="p">)</span>

    <span class="n">best_grid_params</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">best_grid_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">grid_params_MCMC</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">best_grid_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">read_n</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nmissing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An unexpected error occured.  Please contact the authors of AIMS.&quot;</span><span class="p">)</span>
        <span class="n">optimal_amplitudes</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">get_optimal_surface_amplitudes</span><span class="p">(</span><span class="n">best_grid_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">)</span>
        <span class="n">best_grid_params</span> <span class="o">=</span> <span class="n">best_grid_params</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">optimal_amplitudes</span><span class="p">)</span>

    <span class="n">best_grid_params</span> <span class="o">=</span> <span class="n">best_grid_params</span> <span class="o">+</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">best_grid_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">output_params</span><span class="p">)</span></div>


    <span class="c1"># print(&quot;Best model:  &quot; + str(best_grid_result) + &quot; &quot; + str(best_grid_params))</span>
    <span class="c1"># best_grid_model.print_me()</span>


<div class="viewcode-block" id="find_best_model_in_track">
<a class="viewcode-back" href="../AIMS.html#AIMS.find_best_model_in_track">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_best_model_in_track</span><span class="p">(</span><span class="n">ntrack</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scan through an evolutionary track to find &quot;best&quot; model for :py:data:`prob`,</span>
<span class="sd">    the probability function (i.e. the product of priors and a likelihood function).</span>

<span class="sd">    :param ntrack: number of the evolutionary track</span>
<span class="sd">    :type ntrack: int</span>

<span class="sd">    :return: the ln(probability) value, the &quot;best&quot; model, the parameters of accepted models,</span>
<span class="sd">             the parameters of rejected models, the age range of the track, and the numbers</span>
<span class="sd">             of models rejected due to classic constraints, seismic contraints, and priors</span>
<span class="sd">    :rtype: (float, :py:class:`model.Model`, 2D float list, 2D float list, float, int, int, int)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">best_result_local</span> <span class="o">=</span> <span class="n">log0</span>
    <span class="n">best_model_local</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rejected_parameters_local</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accepted_parameters_local</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reject_classic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reject_seismic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reject_prior</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">track</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">ntrack</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
        <span class="n">amodel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_name</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> \
                             <span class="n">_modes</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">track</span><span class="o">.</span><span class="n">mode_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">track</span><span class="o">.</span><span class="n">mode_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">amodel</span><span class="p">)</span>
        <span class="n">reject_classic</span> <span class="o">+=</span> <span class="n">rc</span>
        <span class="n">reject_seismic</span> <span class="o">+=</span> <span class="n">rs</span>
        <span class="n">reject_prior</span> <span class="o">+=</span> <span class="n">rp</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">best_result_local</span><span class="p">):</span>
            <span class="n">best_result_local</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">best_model_local</span> <span class="o">=</span> <span class="n">amodel</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">accepted_parameters_local</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">grid_params_MCMC</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rejected_parameters_local</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">amodel</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">grid_params_MCMC</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">best_result_local</span><span class="p">,</span> <span class="n">best_model_local</span><span class="p">,</span> <span class="n">accepted_parameters_local</span><span class="p">,</span> \
            <span class="n">rejected_parameters_local</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">ntrack</span><span class="p">]</span><span class="o">.</span><span class="n">age_range</span><span class="p">,</span> <span class="n">reject_classic</span><span class="p">,</span> \
            <span class="n">reject_seismic</span><span class="p">,</span> <span class="n">reject_prior</span><span class="p">)</span></div>



<div class="viewcode-block" id="init_walkers">
<a class="viewcode-back" href="../AIMS.html#AIMS.init_walkers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_walkers</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialise the walkers used in emcee.</span>

<span class="sd">    :return: array of starting parameters</span>
<span class="sd">    :rtype: np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">samples_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>

        <span class="c1"># set up initial distributions according to the value of config.tight_ball:</span>

        <span class="k">global</span> <span class="n">tight_ball_distributions</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tight_ball</span><span class="p">):</span>

            <span class="c1"># find the best model:</span>
            <span class="n">find_best_model</span><span class="p">()</span>

            <span class="c1"># create probability distributions for a tight ball:</span>
            <span class="n">tight_ball_distributions</span> <span class="o">=</span> <span class="n">Prior_list</span><span class="p">()</span>  <span class="c1"># just reuse the same class as for the priors</span>

            <span class="c1"># for param_name in grid_params_MCMC:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
                <span class="n">param_name</span> <span class="o">=</span> <span class="n">grid_params_MCMC_with_surf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># the star notation unpacks the tuple:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">param_name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">tight_ball_range</span><span class="p">):</span>
                    <span class="n">new_distrib</span> <span class="o">=</span> <span class="n">Distribution</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="o">.</span><span class="n">tight_ball_range</span><span class="p">[</span><span class="n">param_name</span><span class="p">])</span>
                    <span class="n">new_distrib</span><span class="o">.</span><span class="n">re_centre</span><span class="p">(</span><span class="n">best_grid_params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">tight_ball_distributions</span><span class="o">.</span><span class="n">add_prior</span><span class="p">(</span><span class="n">new_distrib</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">param_name</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">age_str</span><span class="p">):</span>
                        <span class="n">tight_ball_distributions</span><span class="o">.</span><span class="n">add_prior</span><span class="p">(</span>
                            <span class="n">Distribution</span><span class="p">(</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">best_grid_params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">best_age_range</span> <span class="o">/</span> <span class="mf">30.0</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">):</span>
                            <span class="c1"># the parameter is an surface correction parameter</span>
                            <span class="n">param_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">best_grid_params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># the parameter is not an age surface correction parameter</span>
                            <span class="n">param_range</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
                            <span class="n">param_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">param_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">param_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">30.0</span>
                        <span class="n">tight_ball_distributions</span><span class="o">.</span><span class="n">add_prior</span><span class="p">(</span><span class="n">Distribution</span><span class="p">(</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">best_grid_params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">param_range</span><span class="p">]))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set the initial distributions to the priors</span>
            <span class="n">tight_ball_distributions</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">priors</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating walkers...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndims</span><span class="p">])</span>

            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ntotal</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ntemps</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">ntemps</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">batch</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ntotal</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[2A&#39;</span><span class="p">)</span>  <span class="c1"># backup two lines - might not work in all terminals</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">is_outside</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">max_iter</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Too many iterations to produce walkers.&quot;</span><span class="p">)</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="n">tight_ball_distributions</span><span class="o">.</span><span class="n">realisation</span><span class="p">()</span>
                        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">p0</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">params</span>
                    <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ntotal</span><span class="p">))</span>

            <span class="c1"># include the parameters of the best model as the first walker:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tight_ball</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
                    <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_grid_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndims</span><span class="p">])</span>

            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ntotal</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">batch</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ntotal</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[2A&#39;</span><span class="p">)</span>  <span class="c1"># backup two lines - might not work in all terminals</span>
                <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">is_outside</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">max_iter</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Too many iterations to produce walkers.&quot;</span><span class="p">)</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">tight_ball_distributions</span><span class="o">.</span><span class="n">realisation</span><span class="p">()</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">p0</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">params</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ntotal</span><span class="p">))</span>

            <span class="c1"># include the parameters of the best model as the first walker:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tight_ball</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
                    <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_grid_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialise walkers from samples file&quot;</span><span class="p">)</span>

        <span class="c1"># NOTE: the first column contains the ln(P) values and must be discarded</span>
        <span class="n">previous_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">samples_file</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">previous_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">previous_samples</span> <span class="o">=</span> <span class="n">previous_samples</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndims</span><span class="p">))</span>
        <span class="n">nsamples</span> <span class="o">=</span> <span class="n">previous_samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># initiliase walkers by cycling backwards on previous samples in order</span>
        <span class="c1"># to use most &quot;recent&quot; samples first:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
            <span class="c1"># NOTE: the initial distribution on higher temperatures will be the same</span>
            <span class="c1">#       as on lower temperatures, which is not representative of the</span>
            <span class="c1">#       the outcome from a multi-tempered MCMC run.</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndims</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">nsamples</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">ntemps</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">):</span>
                    <span class="n">p0</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">nsamples</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndims</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">nsamples</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">):</span>
                <span class="n">p0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">nsamples</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">p0</span></div>



<div class="viewcode-block" id="run_emcee">
<a class="viewcode-back" href="../AIMS.html#AIMS.run_emcee">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_emcee</span><span class="p">(</span><span class="n">p0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the emcee program.</span>

<span class="sd">    :param p0: the initial set of walkers</span>
<span class="sd">    :type p0: np.array</span>

<span class="sd">    :return: the ``emcee`` sampler for the MCMC run, array with walker percentiles</span>
<span class="sd">             as a function of iteration number</span>
<span class="sd">    :rtype: emcee sampler object, np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of walkers:    </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of steps:      </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of temp.:      </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">ntemps</span><span class="p">))</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">ptemcee</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">default_beta_ladder</span><span class="p">(</span><span class="n">ndims</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">Tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">ptemcee</span><span class="o">.</span><span class="n">Sampler</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span> \
                                  <span class="n">prob</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="n">betas</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>

    <span class="c1"># initialisation of percentiles:</span>
    <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pvalues</span> <span class="o">=</span> <span class="p">(</span><span class="mf">25.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">)</span>

    <span class="c1"># initial burn-in:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Burn-in iterations&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">lnlike</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span><span class="p">,</span> <span class="n">storechain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adapt</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">PTadapt</span><span class="p">),</span>
                <span class="n">total</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span><span class="p">):</span>
            <span class="n">percentiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mc2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">lnlike</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span><span class="p">,</span> <span class="n">storechain</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                          <span class="n">total</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span><span class="p">):</span>
                <span class="n">percentiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="ow">not</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">batch</span><span class="p">),</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">coords</span>
                <span class="n">percentiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1"># production run:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Production iterations&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">lnlike</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">adapt</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">PTadapt</span><span class="p">),</span>
                                      <span class="n">total</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="n">percentiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mc2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">lnlike</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lnprob0</span><span class="o">=</span><span class="n">lnprob</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">),</span>
                                          <span class="n">total</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
                <span class="n">percentiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="ow">not</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">batch</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">coords</span>
                <span class="n">percentiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Print acceptance fraction</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean acceptance fraction: </span><span class="si">{0:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">acceptance_fraction</span><span class="p">)))</span>

    <span class="c1"># Estimate the integrated autocorrelation time for the time series in each parameter.</span>
    <span class="k">global</span> <span class="n">autocorr_time</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
            <span class="n">autocorr_time</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_autocorr_time</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mc2</span><span class="p">):</span>
                <span class="c1"># c: minimum number of autocorrelation times needed to trust estimate (default: 10)</span>
                <span class="n">autocorr_time</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_autocorr_time</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># tol: minimum number of autocorrelation times needed to trust estimate (default: 50)</span>
                <span class="n">autocorr_time</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_autocorr_time</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Autocorrelation time: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">autocorr_time</span><span class="p">)))</span>
    <span class="k">except</span> <span class="n">emcee</span><span class="o">.</span><span class="n">autocorr</span><span class="o">.</span><span class="n">AutocorrError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Autocorrelation time not available&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">percentiles</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_blobs">
<a class="viewcode-back" href="../AIMS.html#AIMS.find_blobs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_blobs</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find blobs (i.e. supplementary output parameters) from a set of samples</span>
<span class="sd">    (i.e. for multiple models).</span>

<span class="sd">    :param samples: input set of samples</span>
<span class="sd">    :type samples: list/array of array-like</span>

<span class="sd">    :return: set of supplementary output parameters</span>
<span class="sd">    :rtype: np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">blobs</span> <span class="o">=</span> <span class="n">my_map</span><span class="p">(</span><span class="n">find_a_blob</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">blobs</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_a_blob">
<a class="viewcode-back" href="../AIMS.html#AIMS.find_a_blob">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_a_blob</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find a blob (i.e. supplementary output parameters) for a given set of parameters</span>
<span class="sd">    (for one model).  The blob also includes the log(P) value as a first entry.</span>

<span class="sd">    :param params: input set of parameters</span>
<span class="sd">    :type params: array-like</span>

<span class="sd">    :return: list of supplementary output parameters</span>
<span class="sd">    :rtype: list of floats</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">my_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">interpolate_model</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">tessellation</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">ndx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">output_params</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_samples">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_samples">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_samples</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write raw samples to a file.</span>

<span class="sd">    :param filename: name of file in which to write the samples</span>
<span class="sd">    :param labels:   names of relevant variables (used to write a header)</span>
<span class="sd">    :param samples:  samples for which statistical properties are calculated</span>

<span class="sd">    :type filename: string</span>
<span class="sd">    :type labels:   list of strings</span>
<span class="sd">    :type samples:  array-like</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># write results to file</span>
    <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:22}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:22.15e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_statistics">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_statistics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_statistics</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write statistical properties based on a sequence of realisations to a file.</span>
<span class="sd">    The results include:</span>

<span class="sd">    - average values for each variable (statistical mean)</span>
<span class="sd">    - error bars for each variable (standard mean deviation)</span>
<span class="sd">    - correlation matrix between the different variables</span>

<span class="sd">    :param filename: name of file in which to write the statistical properties</span>
<span class="sd">    :param labels:   names of relevant variables</span>
<span class="sd">    :param samples:  samples for which statistical properties are calculated</span>

<span class="sd">    :type filename: string</span>
<span class="sd">    :type labels:   list of strings</span>
<span class="sd">    :type samples:  np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialisation</span>
    <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">average</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># find covariance matrix:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">average</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">samples</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">average</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">covariance</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

    <span class="c1"># write results to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Summary</span><span class="se">\n</span><span class="s2">=======</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> </span><span class="si">{1:25.15e}</span><span class="s1"> </span><span class="si">{2:25.15e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">average</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Correlation matrix</span><span class="se">\n</span><span class="s2">==================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25.15e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariance</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])))</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_percentiles">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_percentiles">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_percentiles</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write percentiles based on a sequence of realisations to a file.</span>
<span class="sd">    The results include:</span>

<span class="sd">      +/- 2 sigma error bars (using the 2.5th and 97.5th percentiles)</span>
<span class="sd">      +/- 1 sigma error bars (using the 16th and 84th percentiles)</span>
<span class="sd">      the median value (i.e. the 50th percentile)</span>

<span class="sd">    :param filename: name of file in which to write the percentiles</span>
<span class="sd">    :param labels:   names of relevant variables</span>
<span class="sd">    :param samples:  samples for which statistical properties are calculated</span>

<span class="sd">    :type filename: string</span>
<span class="sd">    :type labels:   list of strings</span>
<span class="sd">    :type samples:  np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># n sigma values (from https://en.wikipedia.org/wiki/Normal_distribution)</span>
    <span class="n">one_sigma</span> <span class="o">=</span> <span class="mf">0.682689492137</span>
    <span class="n">two_sigma</span> <span class="o">=</span> <span class="mf">0.954499736104</span>
    <span class="c1"># three_sigma = 0.997300203937</span>

    <span class="c1"># initialisation</span>
    <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">two_sigma</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">two_sigma</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">one_sigma</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">one_sigma</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">50.0</span><span class="p">)</span>

    <span class="c1"># write results to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Percentiles</span><span class="se">\n</span><span class="s2">===========</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-2sigma&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-1sigma&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Median&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+1sigma&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+2sigma&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:25.15e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_LEGACY_summary">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_LEGACY_summary">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_LEGACY_summary</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">KIC</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a one line summary of the statistical properties based on a</span>
<span class="sd">    sequence of realisations to a file.  The format matches that of the</span>
<span class="sd">    LEGACY project.</span>

<span class="sd">    The results include:</span>

<span class="sd">    - average values for each variable (statistical mean)</span>
<span class="sd">    - error bars for each variable (standard mean deviation)</span>

<span class="sd">    :param filename: name of file in which to write the statistical properties</span>
<span class="sd">    :param KIC: KIC number of the star</span>
<span class="sd">    :param labels:   names of relevant variables</span>
<span class="sd">    :param samples:  samples for which statistical properties are calculated</span>

<span class="sd">    :type filename: string</span>
<span class="sd">    :type KIC: string</span>
<span class="sd">    :type labels:   list of strings</span>
<span class="sd">    :type samples:  np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialisation</span>
    <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">average</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">uncertainties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># find covariance matrix:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">uncertainties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">average</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">average</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">))</span>

    <span class="c1"># write results to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">KIC</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">average</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Radius&#39;</span><span class="p">,</span> <span class="s1">&#39;Mass&#39;</span><span class="p">,</span> <span class="s1">&#39;log_g&#39;</span><span class="p">,</span> <span class="s1">&#39;Rho&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">age_str</span><span class="p">,</span> <span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe_H&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;MCore&#39;</span><span class="p">,</span> <span class="s1">&#39;RCore&#39;</span><span class="p">,</span> <span class="s1">&#39;Mbcz&#39;</span><span class="p">,</span> <span class="s1">&#39;Rbcz&#39;</span><span class="p">,</span> <span class="s1">&#39;Luminosity&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Xsup&#39;</span><span class="p">,</span> <span class="s1">&#39;Ysup&#39;</span><span class="p">,</span> <span class="s1">&#39;Xc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ycen&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">average</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">uncertainties</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="n">uncertainties</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; -99.999 -99.999 -99.999&quot;</span><span class="p">)</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_readme">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_readme">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_readme</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write parameters relevant to this MCMC run.</span>

<span class="sd">    :param filename: name of file in which to write the statistical properties</span>
<span class="sd">    :type filename: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># various format related strings:</span>
    <span class="n">boolean2str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;False&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)</span>
    <span class="n">str_decimal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:40}{1:d}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">str_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:40}{1:40}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">str_float</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:40}{1:22.15e}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Observational constraints&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of modes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">)))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# NOTE: the radial orders may have been recalculated (see Radial orders section)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4}</span><span class="s2"> </span><span class="si">{1:4}</span><span class="s2"> </span><span class="si">{2:17}</span><span class="s2"> </span><span class="si">{3:17}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;dfreq&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4d}</span><span class="s2"> </span><span class="si">{1:4d}</span><span class="s2"> </span><span class="si">{2:17.10e}</span><span class="s2"> </span><span class="si">{3:17.10e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">dfreq</span><span class="p">))</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">distrib</span><span class="p">)</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">distrib</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Seismic constraints&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">seismic_constraints</span><span class="p">)))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Surface option&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008&quot;</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Surface exponent, b&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015&quot;</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Surface parameter, beta&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">beta_Sonoi2015</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">Rkkinv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;WhoSGlAd theta_He&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_He</span><span class="p">))</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;WhoSGlAd theta_BCZ&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">whosglad_Theta_BCZ</span><span class="p">))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Priors&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">distribution</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grid_params_MCMC_with_surf</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">priors</span><span class="o">.</span><span class="n">priors</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Prior on &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">distribution</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>

        <span class="n">nseismic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
        <span class="n">nclassic</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Weighting&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Weight option&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">weight_option</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Absolute seismic weight&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">seismic_weight</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Absolute classic weight&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">classic_weight</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nclassic</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;Relative seismic weight&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">seismic_weight</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nseismic</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nclassic</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;Relative seismic weight&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Relative classic weight&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">classic_weight</span><span class="p">))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Radial orders&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Radial orders from input file&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">read_n</span><span class="p">]))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Radial orders from best model&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">assign_n</span><span class="p">]))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Use radial orders in mode map&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">]))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;The grid and interpolation&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Binary grid&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">binary_grid</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;User defined parameters&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">user_params</span><span class="p">])))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Age interpolation option&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">age_interpolation</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Distort grid prior to tessellation&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">distort_grid</span><span class="p">]))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">distort_grid</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Distortion matrix:&quot;</span><span class="p">)</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">distort_mat</span><span class="p">))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;EMCEE parameters&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;EMCEE version&quot;</span><span class="p">,</span> <span class="n">emcee</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;With parallel tempering&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">]))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;PTEMCEE version&quot;</span><span class="p">,</span> <span class="n">ptemcee</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Adaptive tempering&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">PTadapt</span><span class="p">]))</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of temperatures&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">ntemps</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of walkers&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of burn-in steps&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of production steps&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Thinning parameter&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">thin</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Integrated autocorrelation time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">autocorr_time</span><span class="p">)))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Initialisation&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">samples_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Initialise with a tight ball&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">tight_ball</span><span class="p">]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tight_ball</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">grid_params_MCMC_with_surf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;Tight ball distrib. on &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">tight_ball_distributions</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Initialised with samples from&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">samples_file</span><span class="p">))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Output&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;List of output parameters&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_params</span><span class="p">)))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Write OSM files&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">with_osm</span><span class="p">]))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Plot walkers&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">with_walkers</span><span class="p">]))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Plot echelle diagrams&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">with_echelle</span><span class="p">]))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Plot histograms&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">with_histograms</span><span class="p">]))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Plot triangle plots&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">with_triangles</span><span class="p">]))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;List of plot extensions&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">plot_extensions</span><span class="p">)))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;List of triangle plot extensions&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tri_extensions</span><span class="p">)))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Miscellaneous&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;With parallelisation&quot;</span><span class="p">,</span> <span class="n">boolean2str</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">parallel</span><span class="p">]))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parallel</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of processes&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">nprocesses</span><span class="p">))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Execution time (s)&quot;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of accepted models&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">accepted_parameters</span><span class="p">)))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of rejected models&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_parameters</span><span class="p">)))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;  Classic rejections&quot;</span><span class="p">,</span> <span class="n">nreject_classic</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;  Seismic rejections&quot;</span><span class="p">,</span> <span class="n">nreject_seismic</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_decimal</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;  Prior-based rejections&quot;</span><span class="p">,</span> <span class="n">nreject_prior</span><span class="p">))</span></div>



<div class="viewcode-block" id="write_combinations">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_combinations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_combinations</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produce a list of linear combinations of grid models (based on interpolation) corresponding</span>
<span class="sd">    to the provided model parameters.</span>

<span class="sd">    :param filename: name of the file to which to write the model combinations</span>
<span class="sd">    :param samples: set of model parameters for which we would like to obtain the grid models</span>
<span class="sd">                   and interpolation coefficients</span>

<span class="sd">    :type filename: string</span>
<span class="sd">    :type samples: np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2"> </span><span class="si">{1:e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">G</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">find_combination</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">])</span>
            <span class="n">my_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">interpolate_model</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">tessellation</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">ndx</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># filter out combinations outside the grid</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2"> </span><span class="si">{1:.15e}</span><span class="s2"> </span><span class="si">{2:.15e}</span><span class="s2"> </span><span class="si">{3:.15e}</span><span class="s2"> </span><span class="si">{4:.5f}</span><span class="s2"> </span><span class="si">{5:.5f}</span><span class="s2"> </span><span class="si">{6:.15e}</span><span class="s2"> </span><span class="si">{7:.5f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">imass</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iradius</span><span class="p">],</span>
                <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iluminosity</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iz0</span><span class="p">],</span>
                <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ix0</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">iage</span><span class="p">],</span>
                <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">itemperature</span><span class="p">]))</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.15f}</span><span class="s2"> </span><span class="si">{1:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">model_name</span><span class="p">))</span>

            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_model">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_model">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">my_params</span><span class="p">,</span> <span class="n">my_result</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write text file with caracteristics of input model.</span>

<span class="sd">    :param my_model: model for which we&#39;re writing a text file</span>
<span class="sd">    :param my_params: parameters of the model</span>
<span class="sd">    :param my_result: ln(P) value obtained for the model</span>
<span class="sd">    :param model_name: name used to describe this model.  This is also used</span>
<span class="sd">      when naming the text file.</span>
<span class="sd">    :param extended: if set to True, all of the theoretical modes are</span>
<span class="sd">                     saved in the text file, including those not matched</span>
<span class="sd">                     to observations</span>

<span class="sd">    :type my_model: :py:class:`model.Model`</span>
<span class="sd">    :type my_params: array-like</span>
<span class="sd">    :type my_result: float</span>
<span class="sd">    :type model_name: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># sanity check</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">my_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># initialisations:</span>
    <span class="n">str_float</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:40}{1:22.15e}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">param_names</span> <span class="o">=</span> <span class="n">grid_params_MCMC_with_surf</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">output_params</span>
    <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">)</span>
    <span class="n">mode_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mode_map</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_model.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Model: &quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;ln(P)&quot;</span><span class="p">,</span> <span class="n">my_result</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;ln(P_seismic) (unweighted)&quot;</span><span class="p">,</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">compare_frequency_combinations</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">:</span><span class="n">ndims</span><span class="p">])))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;ln(P_classic) (unweighted)&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">(</span><span class="n">my_model</span><span class="p">)))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;ln(P_priors)&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">priors</span><span class="p">(</span><span class="n">my_params</span><span class="p">[:</span><span class="n">ndims</span><span class="p">])))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">my_params</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_float</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Frequencies&quot;</span><span class="p">))</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_freq</span><span class="p">(</span><span class="n">surface_option</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">:</span><span class="n">ndims</span><span class="p">])</span> \
               <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4}</span><span class="s2"> </span><span class="si">{1:4}</span><span class="s2"> </span><span class="si">{2:17}</span><span class="s2"> </span><span class="si">{3:17}</span><span class="s2"> </span><span class="si">{4:17}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;freq_theo&quot;</span><span class="p">,</span> <span class="s2">&quot;freq_obs&quot;</span><span class="p">,</span> <span class="s2">&quot;dfreq_obs&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">mode_map</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">mode_map</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4d}</span><span class="s2"> </span><span class="si">{1:4d}</span><span class="s2"> </span><span class="si">{2:17.10e}</span><span class="s2"> </span><span class="si">{3:17.10e}</span><span class="s2"> </span><span class="si">{4:17.10e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">],</span>
                        <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">extended</span><span class="p">):</span>
                        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4d}</span><span class="s2"> </span><span class="si">{1:4d}</span><span class="s2"> </span><span class="si">{2:17.10e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4}</span><span class="s2"> </span><span class="si">{1:4}</span><span class="s2"> </span><span class="si">{2:17}</span><span class="s2"> </span><span class="si">{3:17}</span><span class="s2"> </span><span class="si">{4:17}</span><span class="s2"> </span><span class="si">{5:17}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;freq_theo&quot;</span><span class="p">,</span> <span class="s2">&quot;freq+surf. corr.&quot;</span><span class="p">,</span> <span class="s2">&quot;freq_obs&quot;</span><span class="p">,</span> <span class="s2">&quot;dfreq_obs&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">mode_map</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">mode_map</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4d}</span><span class="s2"> </span><span class="si">{1:4d}</span><span class="s2"> </span><span class="si">{2:17.10e}</span><span class="s2"> </span><span class="si">{3:17.10e}</span><span class="s2"> </span><span class="si">{4:17.10e}</span><span class="s2"> </span><span class="si">{5:17.10e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">],</span>
                        <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
                        <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">extended</span><span class="p">):</span>
                        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4d}</span><span class="s2"> </span><span class="si">{1:4d}</span><span class="s2"> </span><span class="si">{2:17.10e}</span><span class="s2"> </span><span class="si">{3:17.10e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">],</span>
                            <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># print seismic constraints</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">ncoeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_title</span><span class="p">(</span><span class="s2">&quot;Seismic constraints&quot;</span><span class="p">))</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ftype</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">aims_fortran</span><span class="o">.</span><span class="n">compare_frequency_combinations</span><span class="p">(</span>
            <span class="n">freq</span><span class="p">,</span> <span class="n">mode_map</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">nfunc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)</span>
        <span class="n">fvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfunc</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ftype</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfunc</span><span class="p">):</span>
            <span class="n">fvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">ncomb</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> \
                         <span class="o">+</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">ncomb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">)):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%20s</span><span class="s2"> </span><span class="si">%.15e</span><span class="s2"> +/- </span><span class="si">%.15e</span><span class="s2">  </span><span class="si">%.15e</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">combination_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]),</span> <span class="n">fvalues</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span></div>



<div class="viewcode-block" id="string_to_title">
<a class="viewcode-back" href="../AIMS.html#AIMS.string_to_title">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">string_to_title</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create fancy title from string.</span>
<span class="sd">    </span>
<span class="sd">    :param string: string from which the title is created.</span>
<span class="sd">    :type string: string</span>

<span class="sd">    :return: the fancy string title</span>
<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">ntitle</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">nhalf</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntitle</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="n">ntitle</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">ntitle</span> <span class="o">-</span> <span class="n">nhalf</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;   &quot;</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="s2">&quot;   &quot;</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="n">nhalf</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="n">ntitle</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="write_osm_frequencies">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_osm_frequencies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_osm_frequencies</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">my_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write file with frequencies for Optimal Stellar Model (OSM), written</span>
<span class="sd">    by R. Samadi.</span>
<span class="sd">    </span>
<span class="sd">    :param filename: name of file which will contain the frequencies</span>
<span class="sd">    :type filename: string</span>

<span class="sd">    :param my_model: model from which are derived the radial orders</span>
<span class="sd">    :type my_model: :py:class:`model.Model`</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">      Written by B. Herbert.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialisations:</span>
    <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_osm</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_freq.dat&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">{0:4}</span><span class="s2"> </span><span class="si">{1:4}</span><span class="s2"> </span><span class="si">{2:17}</span><span class="s2"> </span><span class="si">{3:17}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;nu[muHz]&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma [muHz]&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mode_map</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">mode_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:4d}</span><span class="s2"> </span><span class="si">{1:4d}</span><span class="s2"> </span><span class="si">{2:17.10e}</span><span class="s2"> </span><span class="si">{3:17.10e}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dfreq</span><span class="p">))</span></div>



<div class="viewcode-block" id="write_osm_don">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_osm_don">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_osm_don</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">my_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write file with choice of physical ingredients to be used by CESAM or CESTAM</span>
<span class="sd">    and OSM.</span>
<span class="sd">    </span>
<span class="sd">    :param filename: name of file which will contain the physical ingredients</span>
<span class="sd">    :type filename: string</span>

<span class="sd">    :param my_model: model from which which is derived various physical constraints/settings</span>
<span class="sd">    :type my_model: :py:class:`model.Model`</span>

<span class="sd">    .. note::</span>
<span class="sd">      Written by B. Herbert.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># test mixing length parameter:</span>
    <span class="k">if</span> <span class="s2">&quot;alpha_MLT&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">user_params_index</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;alpha_MLT&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: no &#39;alpha_MLT&#39; parameter in grid.  Using&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         solar-calibrated value in OSM files.&quot;</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.6</span>  <span class="c1"># approximate solar calibrated value</span>

    <span class="c1"># initialisation:</span>
    <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_osm</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_seismic.don&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_CESAM </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_CHEMIN = &#39;/home/hg_central/cestam/SUN_STAR_DATA/eos_opal2005/, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_CTES = &#39;ctes_94_ags09&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_DES = &#39;no_des&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_OUTPUT = &#39;osc_adia&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; N_MAX = 6000, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; PRECISION = &#39;sa&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_MASS </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; MTOT = </span><span class="si">%17e</span><span class="s2"> ,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_PERTM = &#39;pertm_ext&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; MDOT = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_EVOL </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; AGEMAX = </span><span class="si">%17e</span><span class="s2"> , </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">age_str</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; ARRET = &#39;else&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; DTLIST = 1000000000000.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; LOG_TEFF = </span><span class="si">%17e</span><span class="s2"> , </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;log_Teff&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NB_MAX_MODELES = 10000, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; HE_CORE = -1.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; T_STOP = 30000000000.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; X_STOP = -1.0 ,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_CHIM </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; GRILLE_FIXE = F, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_ABON = &#39;solaire_ags09&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; MODIF_CHIM = F, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; GARDE_XISH = F, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; X0 = </span><span class="si">%.15f</span><span class="s2"> , </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Y0 = </span><span class="si">%.15f</span><span class="s2"> , </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; ZSX0 = </span><span class="si">%.15f</span><span class="s2"> , </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;zsx_0&quot;</span><span class="p">))</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_CONV </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_CONV = &#39;conv_jmj&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; ALPHA = </span><span class="si">%17.15f</span><span class="s2"> , </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; OVSHTS = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; OVSHTI = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; JPZ = T, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; CPTURB = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; LEDOUX = F ,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_DIFF </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; DIFFUSION = F, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_DIFFM = &#39;diffm_mp&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_DIFFT = &#39;difft_nu&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; D_TURB = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; RE_NU = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_FRAD = &#39;no_frad&#39; ,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_ROT </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; W_ROT = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; UNIT = &#39;kms/s&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_DIFFW = &#39;diffw_0&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_DIFFMG = &#39;diffmg_0&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_THW = &#39;rot_0&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_PERTW = &#39;pertw_0&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; P_PERTW = 6.5e47, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; LIM_JPZ = T, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_DES_ROT = &#39;no_des&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; TAU_DISK = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; P_DISK = 0.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; W_SAT = 8.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_ETAT </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_ETAT = &#39;etat_opal5Z&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; F_EOS = &#39;eos_opal5_cur_0.013067.bin&#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_OPA </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_OPA = &#39;opa_yveline&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; F_OPA = &#39;opa_yveline_ags09.bin&#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, &#39; &#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_NUC </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_NUC = &#39;ppcno3a9&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_NUC_CPL = &#39;NACRE_LUNA&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; MITLER = F , </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;NL_ATM </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_ATM = &#39;lim_atm&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; NOM_TDETAU = &#39;edding&#39;, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; TAU_MAX = 20.0, </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; LIM_RO = F , </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; / </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_osm_xml">
<a class="viewcode-back" href="../AIMS.html#AIMS.write_osm_xml">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_osm_xml</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">my_params</span><span class="p">,</span> <span class="n">my_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write file with classic constraints for OSM</span>
<span class="sd">    </span>
<span class="sd">    :param filename: name of file with classic constraints</span>
<span class="sd">    :type filename: string</span>

<span class="sd">    :param my_model: model used in deriving some of the constraints</span>
<span class="sd">    :type my_model: :py:class:`model.Model`</span>

<span class="sd">    .. note::</span>
<span class="sd">      Originally written by B. Herbert.  Includes some modifications.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># test mixing length parameter:</span>
    <span class="k">if</span> <span class="s2">&quot;alpha_MLT&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">user_params_index</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;alpha_MLT&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.6</span>  <span class="c1"># approximate solar calibrated value</span>

    <span class="c1"># initialisations:</span>
    <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">)</span>

    <span class="n">biblio_osm</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;teff&quot;</span><span class="p">,</span> <span class="s2">&quot;Teff&quot;</span><span class="p">:</span> <span class="s2">&quot;teff&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;Luminosity&quot;</span><span class="p">:</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;Radius&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="s2">&quot;logg&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;log_g&quot;</span><span class="p">:</span> <span class="s2">&quot;logg&quot;</span><span class="p">}</span>

    <span class="n">config_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>

    <span class="c1"># write free parameters:</span>
    <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;agemax&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">age_str</span><span class="p">),</span> \
                         <span class="mf">20.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">13819.0</span><span class="p">))</span>
    <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;mtot&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">),</span> \
                         <span class="mf">0.03</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span>
    <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;zsx0&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">(</span><span class="s2">&quot;zsx_0&quot;</span><span class="p">),</span> \
                         <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
    <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>

    <span class="c1"># treat surface option:</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008&quot;</span><span class="p">:</span>
        <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;se_a&quot;</span><span class="p">,</span> <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                             <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">numax</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span> \
                             <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008_scaling&quot;</span><span class="p">:</span>
        <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;se_a&quot;</span><span class="p">,</span> <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                             <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">numax</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span> \
                             <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008_2&quot;</span><span class="p">:</span>
        <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;se_a&quot;</span><span class="p">,</span> <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                             <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">numax</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span> \
                             <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;se_b&quot;</span><span class="p">,</span> <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> \
                             <span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015&quot;</span><span class="p">:</span>
        <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;se_a&quot;</span><span class="p">,</span> <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                             <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">),</span> \
                             <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015_2&quot;</span><span class="p">:</span>
        <span class="c1"># Parameter a has already been introduced above.</span>
        <span class="c1"># Hence, only introduce parameter b:</span>
        <span class="n">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="s2">&quot;se_b&quot;</span><span class="p">,</span> <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> \
                             <span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">))</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">distrib</span><span class="p">)</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;M_H&quot;</span><span class="p">):</span>
            <span class="n">target_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
            <span class="n">target_osm</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;log_zsx_s&quot;</span><span class="p">)</span>
            <span class="n">value_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">target_osm</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
            <span class="n">value_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">distrib</span><span class="o">.</span><span class="n">mean</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">solar_z</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">solar_x</span><span class="p">))</span>
            <span class="n">sigma_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">target_osm</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
            <span class="n">sigma_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">distrib</span><span class="o">.</span><span class="n">error_bar</span><span class="p">)</span>
            <span class="n">config_osm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_osm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">biblio_osm</span><span class="p">:</span>
                <span class="n">target_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
                <span class="n">target_osm</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">biblio_osm</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                <span class="n">value_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">target_osm</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="n">value_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">distrib</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
                <span class="n">sigma_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">target_osm</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
                <span class="n">sigma_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%22.15e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">distrib</span><span class="o">.</span><span class="n">error_bar</span><span class="p">)</span>
                <span class="n">config_osm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_osm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: unused constraint in OSM file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param</span><span class="p">))</span>

    <span class="n">seismic_constraints_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;seismic_constraints&quot;</span><span class="p">)</span>
    <span class="n">fich_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">seismic_constraints_osm</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">)</span>
    <span class="n">fich_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_freq.dat&quot;</span>
    <span class="n">types_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">seismic_constraints_osm</span><span class="p">,</span> <span class="s2">&quot;types&quot;</span><span class="p">)</span>
    <span class="n">types_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;nu&quot;</span>
    <span class="n">matching_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">seismic_constraints_osm</span><span class="p">,</span> <span class="s2">&quot;matching&quot;</span><span class="p">)</span>
    <span class="n">matching_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;order&quot;</span>
    <span class="n">config_osm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seismic_constraints_osm</span><span class="p">)</span>

    <span class="n">setting_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">)</span>
    <span class="n">levmar_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">setting_osm</span><span class="p">,</span> <span class="s2">&quot;levmar&quot;</span><span class="p">)</span>
    <span class="n">maxiter_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">levmar_osm</span><span class="p">,</span> <span class="s2">&quot;maxiter&quot;</span><span class="p">)</span>
    <span class="n">maxiter_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">chi2min_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">levmar_osm</span><span class="p">,</span> <span class="s2">&quot;chi2min&quot;</span><span class="p">)</span>
    <span class="n">chi2min_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ftol_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">levmar_osm</span><span class="p">,</span> <span class="s2">&quot;ftol&quot;</span><span class="p">)</span>
    <span class="n">ftol_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">autostep_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">levmar_osm</span><span class="p">,</span> <span class="s2">&quot;autostep&quot;</span><span class="p">)</span>
    <span class="n">autostep_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cov_cdtnb_thr_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">levmar_osm</span><span class="p">,</span> <span class="s2">&quot;cov_cdtnb_thr&quot;</span><span class="p">)</span>
    <span class="n">cov_cdtnb_thr_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1e13</span><span class="p">)</span>
    <span class="n">hess_cdtnb_thr_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">levmar_osm</span><span class="p">,</span> <span class="s2">&quot;hess_cdtnb_thr&quot;</span><span class="p">)</span>
    <span class="n">hess_cdtnb_thr_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1e13</span><span class="p">)</span>

    <span class="n">modes_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">setting_osm</span><span class="p">,</span> <span class="s2">&quot;modes&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008&quot;</span><span class="p">:</span>
        <span class="n">append_osm_surface_effects</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;kb2008&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">,</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                                                                         <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">numax</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span> \
                                                                         <span class="n">config</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008_scaling&quot;</span><span class="p">:</span>
        <span class="n">append_osm_surface_effects</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;kb2008&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">,</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                                                                         <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">numax</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span> \
                                                                         <span class="n">my_model</span><span class="o">.</span><span class="n">b_Kjeldsen2008</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Kjeldsen2008_2&quot;</span><span class="p">:</span>
        <span class="n">append_osm_surface_effects</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;kb2008&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">,</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                                                                         <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">numax</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span> \
                                                                         <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015&quot;</span><span class="p">:</span>
        <span class="n">append_osm_surface_effects</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;lorentz2&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">,</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                                                                           <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span>
                                                                                  <span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">),</span>
                                                                           <span class="n">config</span><span class="o">.</span><span class="n">beta_Sonoi2015</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015_scaling&quot;</span><span class="p">:</span>
        <span class="n">append_osm_surface_effects</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;lorentz2&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">,</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                                                                           <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span>
                                                                                  <span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">),</span>
                                                                           <span class="n">my_model</span><span class="o">.</span><span class="n">beta_Sonoi2015</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="o">==</span> <span class="s2">&quot;Sonoi2015_2&quot;</span><span class="p">:</span>
        <span class="n">append_osm_surface_effects</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;lorentz2&quot;</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">,</span> <span class="p">(</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">]</span> \
                                                                           <span class="o">*</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span>
                                                                                  <span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span> <span class="o">/</span> <span class="n">my_model</span><span class="o">.</span><span class="n">numax</span><span class="p">),</span>
                                                                           <span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="n">oscprog_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;oscprog&quot;</span><span class="p">)</span>
    <span class="n">oscprog_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;adipls&quot;</span>

    <span class="n">models_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">setting_osm</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">)</span>
    <span class="n">dy_dz_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">models_osm</span><span class="p">,</span> <span class="s2">&quot;dy_dz&quot;</span><span class="p">)</span>
    <span class="n">dy_dz_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.44</span><span class="p">)</span>
    <span class="n">yp_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">models_osm</span><span class="p">,</span> <span class="s2">&quot;yp&quot;</span><span class="p">)</span>
    <span class="n">yp_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.2475</span><span class="p">)</span>
    <span class="n">zp_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">models_osm</span><span class="p">,</span> <span class="s2">&quot;zp&quot;</span><span class="p">)</span>
    <span class="n">zp_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">start_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">models_osm</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span>
    <span class="n">start_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;pms&quot;</span>
    <span class="n">cf_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">models_osm</span><span class="p">,</span> <span class="s2">&quot;cf&quot;</span><span class="p">)</span>
    <span class="n">cf_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">8e-5</span><span class="p">)</span>
    <span class="n">config_osm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setting_osm</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_osm</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_seismic.xml&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">))</span></div>



<div class="viewcode-block" id="append_osm_parameter">
<a class="viewcode-back" href="../AIMS.html#AIMS.append_osm_parameter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">append_osm_parameter</span><span class="p">(</span><span class="n">config_osm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a parameter in xlm format in the file with the classic</span>
<span class="sd">    constraints for OSM.</span>

<span class="sd">    :param config_osm: XLM etree element to which to add the parameter</span>
<span class="sd">    :type config_osm: lxml.etree._Element</span>

<span class="sd">    :param name: name of the parameter</span>
<span class="sd">    :type name: string</span>

<span class="sd">    :param value: value of the parameter</span>
<span class="sd">    :type value: float</span>

<span class="sd">    :param step: parameter step (this intervenes when numerically calculating</span>
<span class="sd">                 derivatives with respect to this parameter)</span>
<span class="sd">    :type step: float</span>

<span class="sd">    :param rate: parameter rate (this corresponds to a tolerance on this</span>
<span class="sd">                 parameter)</span>
<span class="sd">    :type rate: float</span>

<span class="sd">    :param bounds: bounds on the parameter</span>
<span class="sd">    :type bounds: float tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parameter_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;parameter&quot;</span><span class="p">)</span>
    <span class="n">parameter_osm</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">value_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parameter_osm</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">value_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">step_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parameter_osm</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">)</span>
    <span class="n">step_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">step</span><span class="p">)</span>
    <span class="n">rate_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parameter_osm</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">)</span>
    <span class="n">rate_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span>
    <span class="n">bounds_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">parameter_osm</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">)</span>
    <span class="n">bounds_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2"> , </span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">config_osm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter_osm</span><span class="p">)</span></div>



<div class="viewcode-block" id="append_osm_surface_effects">
<a class="viewcode-back" href="../AIMS.html#AIMS.append_osm_surface_effects">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">append_osm_surface_effects</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">numax</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a method with which to calculate surface effects to the</span>
<span class="sd">    OSM contraint file.</span>

<span class="sd">    :param modes_osm: XML element to which to add the surface effects method</span>
<span class="sd">    :type modes_osm: lxml.etree._Element</span>

<span class="sd">    :param name: name of the method</span>
<span class="sd">    :type name: string</span>

<span class="sd">    :param numax: value of numax</span>
<span class="sd">    :type numax: float</span>

<span class="sd">    :param values: values which intervene in the method</span>
<span class="sd">    :type values: float tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">surf_effects_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">modes_osm</span><span class="p">,</span> <span class="s2">&quot;surface_effects&quot;</span><span class="p">)</span>
    <span class="n">formula_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">surf_effects_osm</span><span class="p">,</span> <span class="s2">&quot;formula&quot;</span><span class="p">)</span>
    <span class="n">formula_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">params_surf_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">surf_effects_osm</span><span class="p">,</span> <span class="s2">&quot;parameters&quot;</span><span class="p">)</span>
    <span class="n">params_surf_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2"> , </span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">numax_osm</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">surf_effects_osm</span><span class="p">,</span> <span class="s2">&quot;numax&quot;</span><span class="p">)</span>
    <span class="n">numax_osm</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%15.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numax</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_echelle_diagram">
<a class="viewcode-back" href="../AIMS.html#AIMS.plot_echelle_diagram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_echelle_diagram</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">my_params</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produce an echelle diagram for input model.</span>
<span class="sd">    </span>
<span class="sd">    :param my_model: model for which we&#39;re making an echelle diagram</span>
<span class="sd">    :param my_params: parameters of the model</span>
<span class="sd">    :param model_name: name used to describe this model.  This is also used</span>
<span class="sd">      when naming the file with the echelle diagram.</span>

<span class="sd">    :type my_model: :py:class:`model.Model`</span>
<span class="sd">    :type my_params: array-like</span>
<span class="sd">    :type model_name: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># sanity checks</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">my_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># initialisations:</span>
    <span class="n">lmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">]))</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">)</span>
    <span class="n">dnu</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">guess_dnu</span><span class="p">(</span><span class="n">with_n</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dnu</span><span class="p">)):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dnu</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="n">dnu_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:7.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dnu</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dnu</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">):</span>
        <span class="n">dnu_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:4.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dnu</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dnu</span> <span class="o">&lt;</span> <span class="mf">100.0</span><span class="p">):</span>
        <span class="n">dnu_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:4.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dnu</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dnu</span> <span class="o">&lt;</span> <span class="mf">1000.0</span><span class="p">):</span>
        <span class="n">dnu_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:5.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dnu</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dnu_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:7.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dnu</span><span class="p">)</span>

    <span class="n">nu_obs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">error_obs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nu_theo</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">]</span>  <span class="c1"># this should be modified if lmax is modified</span>

    <span class="n">freq</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_freq</span><span class="p">(</span><span class="n">surface_option</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">nu_theo_surf</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">freq_surf</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_freq</span><span class="p">(</span><span class="n">surface_option</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">,</span> \
                                      <span class="n">a</span><span class="o">=</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">:</span><span class="n">ndims</span><span class="p">])</span> \
                    <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span>

    <span class="c1"># obtain frequency sets (and limits)</span>
    <span class="n">nu_min</span> <span class="o">=</span> <span class="mf">1e300</span>
    <span class="n">nu_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e300</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span>
        <span class="n">error_obs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">dfreq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span>
        <span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">freq</span><span class="p">[</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mode_map</span><span class="p">))</span> \
                               <span class="k">if</span> <span class="p">(</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">==</span> <span class="n">l</span><span class="p">)])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">nu_theo_surf</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">freq_surf</span><span class="p">[</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mode_map</span><span class="p">))</span> \
                                        <span class="k">if</span> <span class="p">(</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">==</span> <span class="n">l</span><span class="p">)])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">nu_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">nu_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">])))</span>
            <span class="n">nu_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">])))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">nu_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">nu_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">])))</span>
            <span class="n">nu_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">nu_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">])))</span>

    <span class="n">nu_diff</span> <span class="o">=</span> <span class="n">nu_max</span> <span class="o">-</span> <span class="n">nu_min</span>
    <span class="n">nu_min</span> <span class="o">-=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">nu_diff</span>
    <span class="n">nu_max</span> <span class="o">+=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">nu_diff</span>

    <span class="c1"># make the echelle diagram:</span>
    <span class="c1"># NOTE: (b)lue, (g)reen, (r)ed, (c)yan, (m)agenta, (y)ellow, (k) black, (w)hite</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">dnu</span><span class="p">,</span> <span class="n">dnu</span><span class="p">),</span> <span class="p">(</span><span class="n">nu_min</span><span class="p">,</span> <span class="n">nu_max</span><span class="p">),</span> <span class="s2">&quot;k:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">%</span> <span class="n">dnu</span><span class="p">,</span> <span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">error_obs</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;r&quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">%</span> <span class="n">dnu</span> <span class="o">+</span> <span class="n">dnu</span><span class="p">,</span> <span class="n">nu_obs</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">error_obs</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;r&quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu_theo_surf</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">%</span> <span class="n">dnu</span><span class="p">,</span> <span class="n">nu_theo_surf</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="s2">&quot;c&quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu_theo_surf</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">%</span> <span class="n">dnu</span> <span class="o">+</span> <span class="n">dnu</span><span class="p">,</span> <span class="n">nu_theo_surf</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="s2">&quot;c&quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">%</span> <span class="n">dnu</span><span class="p">,</span> <span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">%</span> <span class="n">dnu</span> <span class="o">+</span> <span class="n">dnu</span><span class="p">,</span> <span class="n">nu_theo</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model: &quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Reduced frequency, $\nu$ mod &quot;</span> <span class="o">+</span> <span class="n">dnu_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; $\mu$Hz&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Frequency, $\nu$ (in $\mu$Hz)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dnu</span> <span class="o">*</span> <span class="mf">1.4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="n">nu_min</span><span class="p">,</span> <span class="n">nu_max</span><span class="p">))</span>

    <span class="c1"># create a legend</span>
    <span class="n">handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\nu_{\mathrm</span><span class="si">{obs}</span><span class="s1">}$&#39;</span><span class="p">]</span>
    <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">))</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\nu_{\mathrm</span><span class="si">{theo}</span><span class="s1">}$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">))</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\nu_{\mathrm</span><span class="si">{theo}</span><span class="s1">}^{\mathrm</span><span class="si">{surf}</span><span class="s1">}$&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">,</span> \
                                     <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-mid&#39;</span><span class="p">))</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell=&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="c1"># save plot</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_extensions</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;echelle_&quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_frequency_diff">
<a class="viewcode-back" href="../AIMS.html#AIMS.plot_frequency_diff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_frequency_diff</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">my_params</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a diagram with frequency differences.</span>
<span class="sd">    </span>
<span class="sd">    :param my_model: model for which we&#39;re plotting frequencie differences</span>
<span class="sd">    :param my_params: parameters of the model</span>
<span class="sd">    :param model_name: name used to describe this model.  This is also used</span>
<span class="sd">      when naming the file with the plot.</span>
<span class="sd">    :param scaled: if True, scale frequency differences by frequency error bars</span>

<span class="sd">    :type my_model: :py:class:`model.Model`</span>
<span class="sd">    :type my_params: array-like</span>
<span class="sd">    :type model_name: string</span>
<span class="sd">    :type scaled: boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># sanity checks</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">my_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># initialisations:</span>
    <span class="n">lmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span><span class="p">]))</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">mode_map</span><span class="p">,</span> <span class="n">nmissing</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">find_map</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">use_n</span><span class="p">)</span>

    <span class="n">n_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">diff_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bd&quot;</span><span class="p">,</span> <span class="s2">&quot;rs&quot;</span><span class="p">,</span> <span class="s2">&quot;g^&quot;</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">]</span>  <span class="c1"># this should be modified if lmax is modified</span>

    <span class="n">freq</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_freq</span><span class="p">(</span><span class="n">surface_option</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">,</span> \
                             <span class="n">a</span><span class="o">=</span><span class="n">my_params</span><span class="p">[</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">:</span><span class="n">ndims</span><span class="p">])</span> <span class="o">*</span> <span class="n">my_model</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span>

    <span class="c1"># obtain frequency differences (and limits)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">n_values</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">n</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span>
        <span class="n">nu_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span>
        <span class="n">error_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mode</span><span class="o">.</span><span class="n">dfreq</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">modes</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">l</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">freq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">nu_theo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mode_map</span><span class="p">))</span> \
                            <span class="k">if</span> <span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][</span><span class="n">mode_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">==</span> <span class="n">l</span><span class="p">)])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scaled</span><span class="p">):</span>
            <span class="n">diff_values</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nu_theo</span> <span class="o">-</span> <span class="n">nu_obs</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_obs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff_values</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu_theo</span> <span class="o">-</span> <span class="n">nu_obs</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n_values</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_values</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">diff_values</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">style</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">msize</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\ell=</span><span class="si">%d</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model: &quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Radial order, $n$&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scaled</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Scaled frequency differences, $(\nu_{\mathrm</span><span class="si">{theo}</span><span class="s2">}-\nu_{\mathrm</span><span class="si">{obs}</span><span class="s2">})/\sigma$&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Frequency differences, $\nu_{\mathrm</span><span class="si">{theo}</span><span class="s2">}-\nu_{\mathrm</span><span class="si">{obs}</span><span class="s2">}$ (in $\mu$Hz)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># save plot</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_extensions</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scaled</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;diff_scaled_&quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;diff_&quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="swap_dimensions">
<a class="viewcode-back" href="../AIMS.html#AIMS.swap_dimensions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">swap_dimensions</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Swaps the two first dimensions of an array.</span>
<span class="sd">    This is useful for handling the different conventions used to store</span>
<span class="sd">    the samples in emcee3 and ptemcee.</span>

<span class="sd">    :param array: input array</span>
<span class="sd">    :type array: np.array</span>

<span class="sd">    :return: array with swapped dimensions</span>
<span class="sd">    :rtype: np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">new_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">new_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_array</span></div>



<div class="viewcode-block" id="plot_walkers">
<a class="viewcode-back" href="../AIMS.html#AIMS.plot_walkers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_walkers</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">nw</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot individual walkers.</span>
<span class="sd">    </span>
<span class="sd">    :param samples: samples from the emcee run</span>
<span class="sd">    :param labels: labels for the different dimensions in parameters space</span>
<span class="sd">    :param filename: specify name of file in which to save plots of walkers.</span>
<span class="sd">    :param nw: number of walkers to be plotted</span>

<span class="sd">    :type samples: np.array</span>
<span class="sd">    :type labels: list of strings</span>
<span class="sd">    :type filename: string</span>
<span class="sd">    :type nw: int</span>

<span class="sd">    .. warning::    </span>
<span class="sd">      This method must be applied before the samples are reshaped,</span>
<span class="sd">      and information on individual walkers lost.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">itr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
            <span class="c1"># plt.subplot(ndims*100+nw*10+1+i+j*nw)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ndims</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">nw</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_extensions</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_distrib_iter_old">
<a class="viewcode-back" href="../AIMS.html#AIMS.plot_distrib_iter_old">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_distrib_iter_old</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot individual distribution of walkers as a function of iterations.</span>
<span class="sd">    </span>
<span class="sd">    :param samples: samples from the emcee run</span>
<span class="sd">    :param labels: labels for the different dimensions in parameters space</span>
<span class="sd">    :param folder: specify name of file in which to save plots of walkers.</span>

<span class="sd">    :type samples: np.array</span>
<span class="sd">    :type labels: list of strings</span>
<span class="sd">    :type folder: string</span>

<span class="sd">    .. warning::    </span>
<span class="sd">      This method must be applied before the samples are reshaped,</span>
<span class="sd">      and information on individual walkers lost.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mid_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yfill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">xfill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="n">mid_values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">50.0</span><span class="p">)</span>
            <span class="n">yfill</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">25.0</span><span class="p">)</span>
            <span class="n">yfill</span><span class="p">[</span><span class="o">-</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">75.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xfill</span><span class="p">,</span> <span class="n">yfill</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xfill</span><span class="p">[:</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">],</span> <span class="n">mid_values</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Iteration, $n$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Walker distribution&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_extensions</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;distrib_iter_&quot;</span> <span class="o">+</span> <span class="n">grid_params_MCMC_with_surf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_distrib_iter">
<a class="viewcode-back" href="../AIMS.html#AIMS.plot_distrib_iter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_distrib_iter</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot individual distribution of walkers as a function of iterations.</span>

<span class="sd">    :param percentiles: array with percentiles from emcee run</span>
<span class="sd">    :param labels: labels for the different dimensions in parameters space</span>
<span class="sd">    :param folder: specify name of file in which to save plots of walkers.</span>

<span class="sd">    :type percentiles: np.array</span>
<span class="sd">    :type labels: list of strings</span>
<span class="sd">    :type folder: string</span>

<span class="sd">    .. warning::    </span>
<span class="sd">      This method must be applied before the samples are reshaped,</span>
<span class="sd">      and information on individual walkers lost.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nsteps</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps</span>  <span class="c1"># total number of steps</span>
    <span class="n">yfill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nsteps</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">xfill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">yfill</span><span class="p">[:</span><span class="n">nsteps</span><span class="p">]</span> <span class="o">=</span> <span class="n">percentiles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># 25th percentile</span>
        <span class="n">yfill</span><span class="p">[</span><span class="n">nsteps</span><span class="p">:]</span> <span class="o">=</span> <span class="n">percentiles</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># 75th percentile</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xfill</span><span class="p">,</span> <span class="n">yfill</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xfill</span><span class="p">[:</span><span class="n">nsteps</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>  <span class="c1"># 50th percentile</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">nsteps0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Iteration, $n$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Walker distribution&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_extensions</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;distrib_iter_&quot;</span> <span class="o">+</span> <span class="n">grid_params_MCMC_with_surf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_histograms">
<a class="viewcode-back" href="../AIMS.html#AIMS.plot_histograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_histograms</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">fancy_names</span><span class="p">,</span> <span class="n">truths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a histogram based on a set of samples.</span>
<span class="sd">    </span>
<span class="sd">    :param samples: samples form the emcee run</span>
<span class="sd">    :param names: names of the quantities represented by the samples.  This will</span>
<span class="sd">      be used when naming the file with the histogram</span>
<span class="sd">    :param fancy_names: name of the quantities represented by the samples. This</span>
<span class="sd">      will be used as the x-axis label in the histogram.</span>
<span class="sd">    :param truths: reference values (typically the true values or some other</span>
<span class="sd">      important values) to be added to the histograms as a vertical line</span>

<span class="sd">    :type samples: np.array</span>
<span class="sd">    :type names: list of strings</span>
<span class="sd">    :type fancy_names: list of strings</span>
<span class="sd">    :type truths: list of floats</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="c1"># n, bins, patches = plt.hist(samples[:,i],50,normed=True,histtype=&#39;bar&#39;)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">truths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">truths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">truths</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">ylim</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>  <span class="c1"># restore limits, just in case</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">fancy_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_extensions</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;histogram_&quot;</span> <span class="o">+</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="interpolation_tests">
<a class="viewcode-back" href="../AIMS.html#AIMS.interpolation_tests">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interpolation_tests</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Carry out various interpolation tests and write results in</span>
<span class="sd">    binary format to file.</span>

<span class="sd">    :param filename: name of file in which to write test results.</span>
<span class="sd">    :type filename: string</span>

<span class="sd">    .. note::</span>
<span class="sd">      The contents of this file may be plotted using methods from</span>
<span class="sd">      ``plot_interpolation_test.py``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">load_binary_data</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">binary_grid</span><span class="p">)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">string_to_latex</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid_params</span> <span class="o">+</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">age_str</span><span class="p">,))</span>
    <span class="n">results_age1</span> <span class="o">=</span> <span class="p">[</span><span class="n">track</span><span class="o">.</span><span class="n">test_interpolation</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">]</span>
    <span class="n">results_age2</span> <span class="o">=</span> <span class="p">[</span><span class="n">track</span><span class="o">.</span><span class="n">test_interpolation</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">]</span>
    <span class="n">results_track</span><span class="p">,</span> <span class="n">ndx1</span><span class="p">,</span> <span class="n">ndx2</span><span class="p">,</span> <span class="n">tessellation</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">test_interpolation</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">ndim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">nglb</span><span class="p">,</span> <span class="n">titles</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">ndx1</span><span class="p">,</span> <span class="n">ndx2</span><span class="p">,</span> <span class="n">tessellation</span><span class="p">,</span>
                   <span class="n">results_age1</span><span class="p">,</span> <span class="n">results_age2</span><span class="p">,</span> <span class="n">results_track</span><span class="p">],</span> <span class="n">output</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_frequencies">
<a class="viewcode-back" href="../AIMS.html#AIMS.plot_frequencies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_frequencies</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot frequencies along an evolutionary track.  For debugging purposes only.</span>

<span class="sd">    :param grid: grid of models</span>
<span class="sd">    :type grid: :py:class:`Model_grid`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># arbitrarily choose one of the tracks:</span>
    <span class="n">ntrack</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">track</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">ntrack</span><span class="p">]</span>

    <span class="c1"># nmin, nmax, lmin, lmax = track.find_mode_range()</span>
    <span class="n">nmin</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="mi">25</span>

    <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$M = </span><span class="si">%.2f</span><span class="s2"> M_{\odot}$, $\log(Z) = </span><span class="si">%.3f</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">track</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">nages</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">find_modes</span><span class="p">(</span><span class="n">nmin</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ages_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ages</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ages</span><span class="p">),</span> <span class="n">nages</span><span class="p">)</span>
    <span class="n">freqs_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nages</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">-</span> <span class="n">nmin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">freqs_ext_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nages</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">-</span> <span class="n">nmin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nages</span><span class="p">):</span>
        <span class="n">aModel</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">interpolate_model</span><span class="p">(</span><span class="n">ages_ext</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmin</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">freqs_ext</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nmin</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">aModel</span><span class="o">.</span><span class="n">find_mode</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                <span class="n">freqs_ext_dim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nmin</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">aModel</span><span class="o">.</span><span class="n">find_mode</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">aModel</span><span class="o">.</span><span class="n">glb</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ifreq_ref</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmin</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">nmin</span><span class="p">:</span>
            <span class="n">label0</span> <span class="o">=</span> <span class="s2">&quot;radial&quot;</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\ell = 1$&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label0</span> <span class="o">=</span> <span class="n">label1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">find_modes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="s2">&quot;b.&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages_ext</span><span class="p">,</span> <span class="n">freqs_ext</span><span class="p">[:,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nmin</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label0</span><span class="p">)</span>
        <span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">find_modes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="s2">&quot;r.&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages_ext</span><span class="p">,</span> <span class="n">freqs_ext</span><span class="p">[:,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nmin</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Stellar age (in Myrs)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Frequency, $\omega/\sqrt{GM/R^3}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;freq_non_dim.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmin</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">nmin</span><span class="p">:</span>
            <span class="n">label0</span> <span class="o">=</span> <span class="s2">&quot;radial&quot;</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\ell = 1$&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label0</span> <span class="o">=</span> <span class="n">label1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">find_modes_dim</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="s2">&quot;b.&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages_ext</span><span class="p">,</span> <span class="n">freqs_ext_dim</span><span class="p">[:,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nmin</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label0</span><span class="p">)</span>
        <span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">find_modes_dim</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="s2">&quot;r.&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages_ext</span><span class="p">,</span> <span class="n">freqs_ext_dim</span><span class="p">[:,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nmin</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Stellar age (in Myrs)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Frequency, $\nu$ (in $\mu$Hz)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;freq_dim.pdf&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AIMS = Asteroseismic Inference on a Massive Scale</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialise the user-defined parameter dictionaries</span>
    <span class="n">model</span><span class="o">.</span><span class="n">init_user_param_dict</span><span class="p">()</span>

    <span class="c1"># this if for writing binary data</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;write_grid&quot;</span><span class="p">):</span>
        <span class="n">write_binary_data</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">list_grid</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">binary_grid</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># this if for testing the interpolation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;test_interpolation&quot;</span><span class="p">):</span>
        <span class="n">interpolation_tests</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation_file</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># sanity check</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;fit_data&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ERROR: unrecognised value (</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">) for the</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;       variable mode in AIMS_configure.py. Aborting&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>

    <span class="c1"># check number of arguments</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Usage: AIMS.py observations_file&quot;</span>

    <span class="c1"># check parameters in AIMS_configure.py</span>
    <span class="n">check_configuration</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AIMS = Asteroseismic Inferences on a Massive Scale&quot;</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># create output folder:</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># check for existence of output folder:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s1">&#39;Unable to overwrite file &quot;</span><span class="si">%s</span><span class="s1">&quot; with folder&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_folder</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: output folder &quot;</span><span class="si">%s</span><span class="s1">&quot; already exists.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_folder</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         Should I empty this folder (y/n)?&#39;</span><span class="p">)</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">answer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;Y&quot;</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>

    <span class="c1"># save a copy of config and input file used</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_folder</span><span class="p">)</span>

    <span class="c1"># create output folder for OSM:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_osm</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_osm</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_osm</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s1">&#39;Unable to overwrite file &quot;</span><span class="si">%s</span><span class="s1">&quot; with folder&#39;</span> <span class="o">%</span> <span class="p">(</span> \
                    <span class="n">config</span><span class="o">.</span><span class="n">output_osm</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_osm</span><span class="p">)</span>

    <span class="c1"># seed random number generator (NOTE: this is not thread-safe):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

    <span class="c1"># define likelihood function:</span>
    <span class="n">like</span> <span class="o">=</span> <span class="n">Likelihood</span><span class="p">()</span>
    <span class="n">like</span><span class="o">.</span><span class="n">read_constraints</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimated large frequency separation (in microHz): &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">guess_dnu</span><span class="p">(</span><span class="n">with_n</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
    <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">add_seismic_constraint</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">seismic_constraints</span><span class="p">)</span>
    <span class="n">like</span><span class="o">.</span><span class="n">find_covariance</span><span class="p">()</span>
    <span class="n">like</span><span class="o">.</span><span class="n">create_combination_arrays</span><span class="p">()</span>
    <span class="n">like</span><span class="o">.</span><span class="n">find_weights</span><span class="p">()</span>

    <span class="c1"># load grid and associated quantities</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">load_binary_data</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">binary_grid</span><span class="p">)</span>
    <span class="n">grid_params_MCMC</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid_params</span> <span class="o">+</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">age_str</span><span class="p">,)</span>
    <span class="n">grid_params_MCMC_with_surf</span> <span class="o">=</span> <span class="n">grid_params_MCMC</span> \
                                 <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">get_surface_parameter_names</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">)</span>
    <span class="n">nsurf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_surface_parameter_names</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">))</span>
    <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_params_MCMC_with_surf</span><span class="p">)</span>

    <span class="c1"># define priors:</span>
    <span class="n">priors</span> <span class="o">=</span> <span class="n">Prior_list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">grid_params_MCMC_with_surf</span><span class="p">:</span>
        <span class="c1"># the star notation unpacks the tuple:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">param_name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">priors</span><span class="p">):</span>
            <span class="n">priors</span><span class="o">.</span><span class="n">add_prior</span><span class="p">(</span><span class="n">Distribution</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="n">param_name</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tight_ball</span><span class="p">):</span>
                <span class="n">priors</span><span class="o">.</span><span class="n">add_prior</span><span class="p">(</span><span class="n">Distribution</span><span class="p">(</span><span class="s2">&quot;Uninformative&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">param_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_surface_parameter_names</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">surface_option</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please define prior for surface effects in configuration file.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">priors</span><span class="o">.</span><span class="n">add_prior</span><span class="p">(</span><span class="n">Distribution</span><span class="p">(</span><span class="s2">&quot;Uniform&quot;</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">param_name</span><span class="p">)))</span>

    <span class="c1"># combine the above:</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">Probability</span><span class="p">(</span><span class="n">priors</span><span class="p">,</span> <span class="n">like</span><span class="p">)</span>

    <span class="c1"># titles, labels, etc.</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ln(P)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">string_to_latex</span><span class="p">,</span> <span class="n">grid_params_MCMC_with_surf</span><span class="p">)</span>
    <span class="n">labels_big</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">+</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">string_to_latex</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">output_params</span><span class="p">)</span>
    <span class="n">names_big</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lnP&quot;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">grid_params_MCMC_with_surf</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">output_params</span>

    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">like</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="n">like</span><span class="o">.</span><span class="n">nonconstraints</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names_big</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning! Constraint </span><span class="si">{</span><span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> has no matching grid/user parameter.&#39;</span><span class="p">)</span>

    <span class="c1"># start pool of parallel processes</span>
    <span class="c1"># NOTE: multiprocessing.pool.TheadPool doesn&#39;t duplicate memory</span>
    <span class="c1">#       like Pool, but can actually slow down execution (even</span>
    <span class="c1">#       compared to non-parallel execution).</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parallel</span><span class="p">):</span>
        <span class="n">set_start_method</span><span class="p">(</span><span class="s2">&quot;fork&quot;</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">nprocesses</span><span class="p">)</span>
        <span class="n">my_map</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">my_map</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span>

    <span class="c1"># initialised walkers:</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">init_walkers</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">assign_n</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">best_grid_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">find_best_model</span><span class="p">()</span>
        <span class="n">like</span><span class="o">.</span><span class="n">clear_seismic_constraints</span><span class="p">()</span>
        <span class="n">like</span><span class="o">.</span><span class="n">assign_n</span><span class="p">(</span><span class="n">best_grid_model</span><span class="p">)</span>
        <span class="n">like</span><span class="o">.</span><span class="n">sort_modes</span><span class="p">()</span>
        <span class="n">like</span><span class="o">.</span><span class="n">create_mode_arrays</span><span class="p">()</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">add_seismic_constraint</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">seismic_constraints</span><span class="p">)</span>
        <span class="n">like</span><span class="o">.</span><span class="n">find_covariance</span><span class="p">()</span>
        <span class="n">like</span><span class="o">.</span><span class="n">create_combination_arrays</span><span class="p">()</span>
        <span class="n">like</span><span class="o">.</span><span class="n">find_weights</span><span class="p">()</span>

    <span class="c1"># run emcee:</span>
    <span class="n">sampler</span><span class="p">,</span> <span class="n">percentiles</span> <span class="o">=</span> <span class="n">run_emcee</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>

    <span class="c1"># Collect results:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PT</span><span class="p">):</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
        <span class="n">lnprob</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">logprobability</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mc2</span><span class="p">):</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span>
            <span class="n">lnprob</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">lnprobability</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">swap_dimensions</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">())</span>
            <span class="n">lnprob</span> <span class="o">=</span> <span class="n">swap_dimensions</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">())</span>

    <span class="c1"># Write file with parameters used in this run</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">write_readme</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;README&quot;</span><span class="p">),</span> <span class="n">elapsed_time</span><span class="p">)</span>

    <span class="c1"># Various diagnostic which must be done before reshaping the samples:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_walkers</span><span class="p">):</span>
        <span class="n">plot_walkers</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;walkers.&quot;</span><span class="p">),</span> <span class="n">nw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_distrib_iter</span><span class="p">):</span>
        <span class="n">plot_distrib_iter</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">output_folder</span><span class="p">)</span>

    <span class="c1"># Reshape the samples and obtain auxiliary quantities:</span>
    <span class="c1"># NOTE: choosing order=&#39;C&#39; leads to much better sub-sampling since the</span>
    <span class="c1">#       the thin_samples array is much more likely to draw from all of the</span>
    <span class="c1">#       walkers rather than a subset. Otherwise, if order=&#39;F&#39; and if</span>
    <span class="c1">#       nwalkers is a multiple of thin, than only 1 out thin walkers</span>
    <span class="c1">#       is used (and this leads to poor sampling, repititions, etc.).</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">ndims</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">lnprob</span> <span class="o">=</span> <span class="n">lnprob</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lnprob</span><span class="p">,</span> <span class="n">samples</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">thin_samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">config</span><span class="o">.</span><span class="n">thin</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">blobs</span> <span class="o">=</span> <span class="n">find_blobs</span><span class="p">(</span><span class="n">thin_samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">samples_big</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">thin_samples</span><span class="p">,</span> <span class="n">blobs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># end pool of parallel processes</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parallel</span><span class="p">):</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># write various text files:</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">write_samples</span><span class="p">:</span>
        <span class="n">write_samples</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;samples.txt&quot;</span><span class="p">),</span> <span class="n">labels</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
        <span class="n">write_samples</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;samples_big.txt&quot;</span><span class="p">),</span> <span class="n">labels_big</span><span class="p">,</span> <span class="n">samples_big</span><span class="p">)</span>
    <span class="n">write_statistics</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;results.txt&quot;</span><span class="p">),</span> <span class="n">names_big</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">write_statistics</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;results_big.txt&quot;</span><span class="p">),</span> <span class="n">names_big</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">samples_big</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">write_percentiles</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;percentiles.txt&quot;</span><span class="p">),</span> \
                      <span class="n">names_big</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">write_percentiles</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;percentiles_big.txt&quot;</span><span class="p">),</span> \
                      <span class="n">names_big</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">samples_big</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_combinations</span><span class="p">):</span>
        <span class="n">write_combinations</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;combinations.txt&quot;</span><span class="p">),</span> <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">config</span><span class="o">.</span><span class="n">thin_comb</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># write best grid model</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">best_grid_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">write_model</span><span class="p">(</span><span class="n">best_grid_model</span><span class="p">,</span> <span class="n">best_grid_params</span><span class="p">,</span> <span class="n">best_grid_result</span><span class="p">,</span> \
                    <span class="s2">&quot;best_grid&quot;</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">extended_model</span><span class="p">)</span>
        <span class="n">write_combinations</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;combinations_best_grid.txt&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">best_grid_params</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_echelle</span><span class="p">):</span>
            <span class="n">plot_echelle_diagram</span><span class="p">(</span><span class="n">best_grid_model</span><span class="p">,</span> <span class="n">best_grid_params</span><span class="p">,</span> <span class="s2">&quot;Best grid&quot;</span><span class="p">)</span>
        <span class="n">plot_frequency_diff</span><span class="p">(</span><span class="n">best_grid_model</span><span class="p">,</span> <span class="n">best_grid_params</span><span class="p">,</span> <span class="s2">&quot;Best grid&quot;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plot_frequency_diff</span><span class="p">(</span><span class="n">best_grid_model</span><span class="p">,</span> <span class="n">best_grid_params</span><span class="p">,</span> <span class="s2">&quot;Best grid&quot;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># find best MCMC model</span>
    <span class="n">ndx_max</span> <span class="o">=</span> <span class="n">lnprob</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">best_MCMC_result</span> <span class="o">=</span> <span class="n">lnprob</span><span class="p">[</span><span class="n">ndx_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">best_MCMC_params</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">ndx_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">best_MCMC_params</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span>
    <span class="n">best_MCMC_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">interpolate_model</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">best_MCMC_params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">tessellation</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">ndx</span><span class="p">)</span>
    <span class="n">best_MCMC_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">best_MCMC_params</span><span class="p">)</span> <span class="o">+</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">best_MCMC_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">output_params</span><span class="p">)</span>
    <span class="n">write_model</span><span class="p">(</span><span class="n">best_MCMC_model</span><span class="p">,</span> <span class="n">best_MCMC_params</span><span class="p">,</span> <span class="n">best_MCMC_result</span><span class="p">,</span> \
                <span class="s2">&quot;best_MCMC&quot;</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">extended_model</span><span class="p">)</span>
    <span class="n">write_combinations</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;combinations_best_MCMC.txt&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">best_MCMC_params</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_echelle</span><span class="p">):</span>
        <span class="n">plot_echelle_diagram</span><span class="p">(</span><span class="n">best_MCMC_model</span><span class="p">,</span> <span class="n">best_MCMC_params</span><span class="p">,</span> <span class="s2">&quot;Best MCMC&quot;</span><span class="p">)</span>
    <span class="n">plot_frequency_diff</span><span class="p">(</span><span class="n">best_MCMC_model</span><span class="p">,</span> <span class="n">best_MCMC_params</span><span class="p">,</span> <span class="s2">&quot;Best MCMC&quot;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plot_frequency_diff</span><span class="p">(</span><span class="n">best_MCMC_model</span><span class="p">,</span> <span class="n">best_MCMC_params</span><span class="p">,</span> <span class="s2">&quot;Best MCMC&quot;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># find statistical model</span>
    <span class="n">statistical_params</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span>
    <span class="n">statistical_params</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ndims</span><span class="p">)</span>
    <span class="n">statistical_result</span> <span class="o">=</span> <span class="n">prob</span><span class="p">(</span><span class="n">statistical_params</span><span class="p">)</span>
    <span class="n">statistical_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">interpolate_model</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">statistical_params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">tessellation</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">ndx</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">statistical_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">statistical_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">statistical_params</span><span class="p">)</span> <span class="o">+</span> <span class="n">utilities</span><span class="o">.</span><span class="n">my_map</span><span class="p">(</span><span class="n">statistical_model</span><span class="o">.</span><span class="n">string_to_param</span><span class="p">,</span>
                                                                         <span class="n">config</span><span class="o">.</span><span class="n">output_params</span><span class="p">)</span>
        <span class="n">write_model</span><span class="p">(</span><span class="n">statistical_model</span><span class="p">,</span> <span class="n">statistical_params</span><span class="p">,</span> <span class="n">statistical_result</span><span class="p">,</span> \
                    <span class="s2">&quot;statistical&quot;</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">extended_model</span><span class="p">)</span>
        <span class="n">write_combinations</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;combinations_statistical.txt&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">statistical_params</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_echelle</span><span class="p">):</span>
            <span class="n">plot_echelle_diagram</span><span class="p">(</span><span class="n">statistical_model</span><span class="p">,</span> <span class="n">statistical_params</span><span class="p">,</span> <span class="s2">&quot;statistical&quot;</span><span class="p">)</span>
        <span class="n">plot_frequency_diff</span><span class="p">(</span><span class="n">statistical_model</span><span class="p">,</span> <span class="n">statistical_params</span><span class="p">,</span> <span class="s2">&quot;statistical&quot;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plot_frequency_diff</span><span class="p">(</span><span class="n">statistical_model</span><span class="p">,</span> <span class="n">statistical_params</span><span class="p">,</span> <span class="s2">&quot;statistical&quot;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># write OSM files:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_osm</span><span class="p">):</span>
        <span class="n">write_osm_frequencies</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">best_MCMC_model</span><span class="p">)</span>
        <span class="n">write_osm_don</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">best_MCMC_model</span><span class="p">)</span>
        <span class="n">write_osm_xml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">best_MCMC_params</span><span class="p">,</span> <span class="n">best_MCMC_model</span><span class="p">)</span>

    <span class="c1"># write one line summary for the LEGACY project</span>
    <span class="c1"># write_LEGACY_summary(os.path.join(output_folder,&quot;LEGACY_summary.txt&quot;), \</span>
    <span class="c1">#                     sys.argv[1][3:], names_big[1:], samples_big[:,1:])</span>

    <span class="c1"># make various plots:</span>
    <span class="n">obs_constraints</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">names_big</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_big</span><span class="p">):</span>
        <span class="n">i_constraint</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i_nonconstraint</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i_constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">constraints</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">nonconstraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i_nonconstraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">nonconstraints</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_constraint</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obs_constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">like</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="n">i_constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_nonconstraint</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obs_constraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">like</span><span class="o">.</span><span class="n">nonconstraints</span><span class="p">[</span><span class="n">i_nonconstraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span>
    <span class="n">obs_constraints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obs_constraints</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">best_grid_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">plot_histograms</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lnP&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;ln(P)&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_histograms</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lnP&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;ln(P)&quot;</span><span class="p">],</span> <span class="n">truths</span><span class="o">=</span><span class="p">[</span><span class="n">best_grid_result</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_histograms</span><span class="p">):</span>
        <span class="n">plot_histograms</span><span class="p">(</span><span class="n">samples_big</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">names_big</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">labels_big</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">truths</span><span class="o">=</span><span class="n">obs_constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_rejected</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rejected_parameters</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rejected_parameters</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">tri_extensions</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;rejected.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accepted_parameters</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accepted_parameters</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">ndims</span> <span class="o">-</span> <span class="n">nsurf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">tri_extensions</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;accepted.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">with_triangles</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">truths</span><span class="o">=</span><span class="n">obs_constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">ndims</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">tri_extensions</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;triangle.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="n">triangle_ind</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">samples_big</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">triangle_truths_ind</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">samples_big</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;triangle_params&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">triangle_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">triangle_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_big</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">triangle_params</span><span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples_big</span><span class="p">[:,</span> <span class="n">triangle_ind</span><span class="p">],</span> <span class="n">truths</span><span class="o">=</span><span class="n">obs_constraints</span><span class="p">[</span><span class="n">triangle_ind</span><span class="p">],</span>
                            <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels_big</span><span class="p">)[</span><span class="n">triangle_ind</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">tri_extensions</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;triangle_big.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Daniel R. Reese.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>